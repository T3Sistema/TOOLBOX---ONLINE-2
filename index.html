<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToolBox Triad3</title>
    <link rel="icon" href="https://aisfizoyfpcisykarrnt.supabase.co/storage/v1/object/public/imagens/LOGO%20TRIAD3%20.png" type="image/jpeg">
    <meta name="description" content="Um sistema completo de ferramentas com login, dashboard, e temas.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /*
         * RESET E CONFIGURAÇÕES GLOBAIS
         */
        :root {
            --font-main: 'Poppins', 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', sans-serif;
            
            /* Temas serão controlados via data-attribute no <html> */
            --color-light-bg: #f0f2f5;
            --color-light-surface: #ffffff;
            --color-light-text: #1a202c;
            --color-light-text-secondary: #5a6474;
            --color-light-accent: #3b82f6;
            --color-light-accent-hover: #2563eb;
            --color-light-border: #e2e8f0;
            --color-light-shadow: rgba(0, 0, 0, 0.08);

            --color-dark-bg: #1a1a1a;
            --color-dark-surface: #242424;
            --color-dark-text: #e8e8e8;
            --color-dark-text-secondary: #a0aec0;
            --color-dark-accent: #4ade80;
            --color-dark-accent-hover: #22c55e;
            --color-dark-border: #363636;
            --color-dark-shadow: rgba(0, 0, 0, 0.25);
            
            --color-triad-cyan: #00d2ff;
            --color-triad-pink: #f92772;

            /* Terceiro tema, agora 'Triad', usando as cores da logo */
            --color-neon-bg: #0d0221;
            --color-neon-surface: #140536;
            --color-neon-text: #e5e7eb;
            --color-neon-text-secondary: #9ca3af;
            --color-neon-accent: var(--color-triad-cyan);
            --color-neon-accent-hover: #33e0ff;
            --color-neon-border: rgba(0, 210, 255, 0.2);
            --color-neon-glow: 0 0 4px var(--color-triad-cyan), 0 0 8px var(--color-triad-cyan), 0 0 12px rgba(0, 210, 255, 0.5);
            --color-neon-shadow: rgba(0, 210, 255, 0.15);
            
            /* Aplicação inicial das variáveis */
            --color-bg: var(--color-dark-bg);
            --color-surface: var(--color-dark-surface);
            --color-text: var(--color-dark-text);
            --color-text-secondary: var(--color-dark-text-secondary);
            --color-accent: var(--color-dark-accent);
            --color-accent-hover: var(--color-dark-accent-hover);
            --color-border: var(--color-dark-border);
            --color-shadow: var(--color-dark-shadow);
            --color-glow: none;
            
            --transition-speed: 0.3s;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }
        
        [data-theme='light'] {
            --color-bg: var(--color-light-bg);
            --color-surface: var(--color-light-surface);
            --color-text: var(--color-light-text);
            --color-text-secondary: var(--color-light-text-secondary);
            --color-accent: var(--color-light-accent);
            --color-accent-hover: var(--color-light-accent-hover);
            --color-border: var(--color-light-border);
            --color-shadow: var(--color-light-shadow);
            --color-glow: none;
        }

        [data-theme='dark'] {
            --color-bg: var(--color-dark-bg);
            --color-surface: var(--color-dark-surface);
            --color-text: var(--color-dark-text);
            --color-text-secondary: var(--color-dark-text-secondary);
            --color-accent: var(--color-dark-accent);
            --color-accent-hover: var(--color-dark-accent-hover);
            --color-border: var(--color-dark-border);
            --color-shadow: var(--color-dark-shadow);
            --color-glow: none;
        }

        [data-theme='neon'] {
            --color-bg: var(--color-neon-bg);
            --color-surface: var(--color-neon-surface);
            --color-text: var(--color-neon-text);
            --color-text-secondary: var(--color-neon-text-secondary);
            --color-accent: var(--color-neon-accent);
            --color-accent-hover: #33e0ff;
            --color-border: var(--color-neon-border);
            --color-shadow: var(--color-neon-shadow);
            --color-glow: var(--color-neon-glow);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            overflow-x: hidden;
            font-synthesis: none;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        button {
            font-family: var(--font-main);
            cursor: pointer;
        }
        
        .hidden {
            display: none !important;
        }
        
        /*
         * TELA DE LOGIN 
         */
        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            background: #000;
            overflow: hidden;
            position: relative;
        }
        
        .login-page::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(125deg, #0d0221, #0c0028, #18033a, #0c0028, #0d0221);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            z-index: 0;
        }

        .login-container {
            position: relative;
            z-index: 1;
            padding: 40px;
            background: rgba(10, 5, 25, 0.4);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 210, 255, 0.25);
            text-align: center;
            width: 90%;
            max-width: 400px;
            animation: fadeIn 0.8s ease-out forwards;
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 24px;
            border: 3px solid var(--color-triad-cyan);
            box-shadow: 0 0 25px rgba(0, 210, 255, 0.6), inset 0 0 10px rgba(0, 210, 255, 0.4);
            transition: transform 0.4s ease;
        }
        .login-logo:hover {
            transform: scale(1.05) rotate(5deg);
        }

        .login-container h1 {
            margin-bottom: 24px;
            color: var(--color-triad-cyan);
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.8);
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: left;
            position: relative;
        }

        .input-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--color-neon-border);
            border-radius: var(--border-radius-sm);
            background: rgba(0, 0, 0, 0.4);
            color: var(--color-text);
            font-size: 1rem;
            font-family: var(--font-main);
            outline: none;
            transition: border-color var(--transition-speed), background-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .input-group input[type="password"] { padding-right: 50px; }
        
        .input-group input:focus {
            border-color: var(--color-triad-cyan);
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-triad-cyan) 20%, transparent);
        }

        .phone-input-container {
            display: flex;
            gap: 8px;
        }

        .phone-input-container select {
            flex: 0 0 120px; /* Largura fixa para o seletor de país */
            padding: 14px;
            border: 1px solid var(--color-neon-border);
            border-radius: var(--border-radius-sm);
            background-color: rgba(0, 0, 0, 0.4);
            color: var(--color-text);
            font-size: 1rem;
            font-family: var(--font-main);
            outline: none;
            transition: border-color var(--transition-speed), background-color var(--transition-speed), box-shadow var(--transition-speed);
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a0aec0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        
        .phone-input-container select:focus {
             border-color: var(--color-triad-cyan);
             background-color: rgba(0, 0, 0, 0.6);
             box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-triad-cyan) 20%, transparent);
        }

        .phone-input-container input {
            flex-grow: 1;
        }

        .toggle-password {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 5px;
            height: 40px;
            width: 40px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }
        .toggle-password:hover { color: var(--color-triad-cyan); }

        .input-group input::placeholder { color: var(--color-text-secondary); opacity: 0.8; }

        .login-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: var(--border-radius-sm);
            background: linear-gradient(45deg, var(--color-triad-cyan), #33e0ff);
            color: #0d0221;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s, background-color 0.3s;
            box-shadow: 0 0 8px rgba(0, 210, 255, 0.5);
        }
        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--color-triad-cyan);
        }

        .login-btn:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .admin-btn {
            width: 100%;
            padding: 10px 14px;
            margin-top: 12px;
            border: 1px solid var(--color-triad-cyan);
            border-radius: var(--border-radius-sm);
            background-color: transparent;
            color: var(--color-triad-cyan);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background-color: var(--color-triad-cyan);
            color: #0d0221;
            box-shadow: 0 0 15px var(--color-triad-cyan);
        }
        
        .switch-form-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 24px;
            padding: 4px;
            transition: color var(--transition-speed) ease;
        }
        .switch-form-btn:hover { color: var(--color-triad-cyan); text-decoration: underline; }

        .error-message, .success-message {
            margin-top: 16px;
            font-weight: 500;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity var(--transition-speed) ease, max-height var(--transition-speed) ease, margin-top var(--transition-speed) ease;
        }
        .error-message { color: var(--color-triad-pink); }
        .success-message { color: var(--color-dark-accent); }
        
        .error-message.show, .success-message.show {
            opacity: 1;
            max-height: 100px; /* Aumentado para acomodar mensagens mais longas */
        }

        .login-separator {
            display: flex;
            align-items: center;
            text-align: center;
            color: var(--color-text-secondary);
            margin: 24px 0;
        }
        .login-separator::before,
        .login-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--color-neon-border);
        }
        .login-separator span {
            padding: 0 1em;
        }
        
        .login-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        .login-actions .admin-btn {
            margin-top: 0;
        }
        .login-actions .switch-form-btn {
            margin-top: 0;
        }
        
        /*
         * TELA DE CARREGAMENTO
         */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(10, 5, 25, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        @keyframes pulse-spin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); border-top-color: var(--color-triad-pink); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(0, 210, 255, 0.3);
            border-top-color: var(--color-triad-cyan);
            border-radius: 50%;
            animation: pulse-spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: var(--color-triad-cyan);
            font-size: 1.2rem;
            font-weight: 500;
            text-shadow: 0 0 8px rgba(0, 210, 255, 0.7);
        }
        
        /*
         * PAINEL ADMINISTRATIVO 
         */
        .admin-panel {
            width: 90%;
            max-width: 800px;
            padding: 32px;
            background: var(--color-neon-surface);
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--color-neon-border);
            display: flex;
            flex-direction: column;
            gap: 24px;
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .admin-panel-header {
            text-align: left;
            border-bottom: 1px solid var(--color-neon-border);
            padding-bottom: 16px;
            margin-bottom: 8px;
        }
        
        #admin-actions-section .admin-panel { position: relative; }
        
        #admin-actions-section .admin-panel-header { text-align: center; border-bottom: none; margin-bottom: 0; }

        .admin-panel-header h2 {
            color: var(--color-triad-cyan);
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 600;
            text-shadow: var(--color-glow);
        }
        .admin-panel-header p { color: var(--color-text-secondary); font-size: 1rem; }

        #onboarding-section .admin-panel-header { text-align: center; }
        #onboarding-section .admin-panel-header p { line-height: 1.7; margin-top: 16px; }

        .admin-form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 500; font-size: 0.9rem; color: var(--color-text-secondary); }

        .admin-panel input, .admin-panel select, .admin-panel textarea {
            width: 100%; padding: 12px; border: 1px solid var(--color-neon-border);
            border-radius: var(--border-radius-sm); background: rgba(0, 0, 0, 0.4);
            color: var(--color-text); font-size: 1rem; font-family: var(--font-main);
            outline: none; transition: all var(--transition-speed);
        }
        
        .admin-panel input::placeholder, .admin-panel textarea::placeholder { color: var(--color-text-secondary); }

        .admin-panel input:focus, .admin-panel select:focus, .admin-panel textarea:focus {
            border-color: var(--color-triad-cyan); background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-triad-cyan) 20%, transparent);
        }
        .admin-panel textarea { resize: vertical; min-height: 100px; }

        /* Estilos para o Toggle Switch de Status */
        .status-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 48.5px; /* Alinhar com outros inputs */
            padding-left: 5px; /* Pequeno ajuste de alinhamento */
        }

        .status-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .status-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--color-dark-accent);
        }

        [data-theme='neon'] input:checked + .slider {
            background-color: var(--color-triad-cyan);
        }
        
        [data-theme='light'] input:checked + .slider {
            background-color: var(--color-light-accent);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        #edit-tool-status-text {
            font-weight: 500;
            color: var(--color-text);
            transition: color 0.3s ease;
        }

        .category-actions { display: flex; gap: 12px; margin-top: 8px; }
        .category-actions .admin-btn { width: 50%; margin-top: 0; padding-top: 12px; padding-bottom: 12px; }
        .category-actions .admin-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; border-color: #555; }

        .category-display-box {
            width: 100%; padding: 12px; border: 1px solid var(--color-neon-border); border-radius: var(--border-radius-sm);
            background: rgba(0, 0, 0, 0.4); color: var(--color-text-secondary);
            font-size: 1rem; min-height: 48.5px; display: flex; align-items: center;
            transition: all var(--transition-speed);
        }
        .category-display-box.active { border-color: var(--color-triad-cyan); background: rgba(0, 0, 0, 0.6); }
        #selected-category-text.selected { color: var(--color-text); }


        #emoji-input-container, #edit-emoji-input-container {
            display: flex; align-items: center; gap: 16px;
            background-color: rgba(0, 0, 0, 0.4); border: 1px solid var(--color-neon-border);
            padding: 8px 12px; border-radius: var(--border-radius-sm); transition: border-color 0.3s ease;
        }

        #emoji-input-container:has(#emoji-select-btn:hover),
        #edit-emoji-input-container:has(#edit-emoji-select-btn:hover) { border-color: var(--color-triad-cyan); }
        
        #selected-emoji, #edit-selected-emoji { font-size: 2rem; line-height: 1; }

        #emoji-select-btn, #edit-emoji-select-btn {
            padding: 8px 16px; border: 1px solid var(--color-triad-cyan); background: transparent;
            color: var(--color-triad-cyan); border-radius: 6px; cursor: pointer;
            transition: all 0.2s ease; margin-left: auto;
        }
        #emoji-select-btn:hover, #edit-emoji-select-btn:hover { background: var(--color-triad-cyan); color: #0d0221; box-shadow: var(--color-glow); }

        #emoji-picker, #edit-emoji-picker {
            position: absolute; z-index: 10; width: 100%;
            background: var(--color-neon-surface); border: 1px solid var(--color-neon-border);
            border-radius: var(--border-radius-sm); padding: 12px; margin-top: 8px;
            box-shadow: 0 4px 20px var(--color-neon-shadow); display: flex;
            overflow-x: auto; gap: 4px; scrollbar-width: thin;
            scrollbar-color: var(--color-neon-accent) transparent;
        }
        
        #emoji-picker::-webkit-scrollbar, #edit-emoji-picker::-webkit-scrollbar { height: 10px; }
        #emoji-picker::-webkit-scrollbar-track, #edit-emoji-picker::-webkit-scrollbar-track { background: transparent; margin: 0 12px; }
        #emoji-picker::-webkit-scrollbar-thumb, #edit-emoji-picker::-webkit-scrollbar-thumb {
            background-color: var(--color-neon-accent); border-radius: 5px;
            border: 2px solid var(--color-neon-surface);
        }

        .emoji-option {
            cursor: pointer; font-size: 1.5rem; text-align: center;
            padding: 4px; border-radius: 4px; transition: background-color 0.2s;
        }
        .emoji-option:hover { background-color: rgba(0, 210, 255, 0.5); }
        
        .progress-bar-container {
            width: 100%; background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px; margin-bottom: 20px; overflow: hidden;
            height: 10px; border: 1px solid rgba(0, 210, 255, 0.25);
        }
        @keyframes progress-stripes { from { background-position: 40px 0; } to { background-position: 0 0; } }
        .progress-bar-fill {
            width: 0%; height: 100%; background-color: var(--color-triad-cyan);
            border-radius: 8px; transition: width 0.4s ease-in-out;
            box-shadow: 0 0 10px var(--color-triad-cyan);
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
            animation: progress-stripes 2s linear infinite;
        }
        
        .admin-panel-footer { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--color-neon-border); }
        .admin-panel-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px; }
        .admin-panel-actions .login-btn, .admin-panel-actions .admin-btn { width: auto; margin-top: 0; }
        .admin-action-buttons { display: flex; flex-direction: column; gap: 16px; width: 100%; padding: 0 48px; }
        .admin-action-buttons .login-btn { width: 100%; }

        .admin-btn.secondary {
            background-color: transparent; color: var(--color-text-secondary);
            border-color: var(--color-text-secondary);
        }
        .admin-btn.secondary:hover { background-color: var(--color-text-secondary); color: var(--color-bg); box-shadow: none; }
        
        #edit-tool-list, #delete-tool-list, #edit-category-list, #new-user-list {
            display: flex; flex-direction: column; gap: 12px;
            max-height: 400px; overflow-y: auto; padding-right: 8px;
        }
        .tool-edit-item {
            display: flex; align-items: center; padding: 12px;
            border: 1px solid var(--color-neon-border); border-radius: var(--border-radius-sm);
            background: rgba(0,0,0,0.4); color: var(--color-text);
            text-align: left; transition: all 0.2s ease;
        }
        .tool-edit-item:hover {
            border-color: var(--color-triad-cyan); background: rgba(0, 210, 255, 0.1);
            transform: translateX(4px); box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
        }
        #delete-tool-list .tool-edit-item:hover {
            border-color: var(--color-triad-pink); background: rgba(249, 39, 114, 0.1);
            box-shadow: 0 0 10px rgba(249, 39, 114, 0.2);
        }
        .tool-edit-item .tool-icon { font-size: 1.5rem; margin-right: 16px; }
        .tool-edit-info { flex-grow: 1; }
        .tool-edit-info strong { font-size: 1.1rem; font-weight: 500; }
        .tool-edit-info span { font-size: 0.9rem; color: var(--color-text-secondary); }
        .edit-arrow { font-size: 1.5rem; color: var(--color-text-secondary); transition: color 0.2s; }
        .tool-edit-item:hover .edit-arrow { color: var(--color-triad-cyan); }
        #delete-tool-list .tool-edit-item:hover .edit-arrow { color: var(--color-triad-pink); }
        
        .tool-name-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-indicator.active {
            background-color: var(--color-dark-accent);
            box-shadow: 0 0 8px var(--color-dark-accent);
        }

        [data-theme='neon'] .status-indicator.active {
            background-color: var(--color-triad-cyan);
            box-shadow: 0 0 8px var(--color-triad-cyan);
        }
        
        [data-theme='light'] .status-indicator.active {
            background-color: #22c55e;
            box-shadow: 0 0 8px #22c55e;
        }

        .status-indicator.inactive {
            background-color: var(--color-triad-pink);
            box-shadow: 0 0 8px var(--color-triad-pink);
        }

        #edit-tool-section .admin-panel-header { display: flex; justify-content: space-between; align-items: center; }
        #edit-tool-section .admin-panel-header .admin-btn { padding: 6px 12px; font-size: 0.8rem; margin-top: 0; width: auto; }
        
        .notification-bell {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 10;
        }

        .notification-bell.has-notification::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 10px;
            height: 10px;
            background-color: var(--color-triad-pink);
            border-radius: 50%;
            border: 2px solid var(--color-neon-surface);
            box-shadow: 0 0 8px var(--color-triad-pink);
        }
        
        .notification-bell.has-notification #notification-btn {
            animation: ring 2s 1s ease-in-out infinite;
        }

        @keyframes ring {
          0% { transform: rotate(0); }
          10% { transform: rotate(25deg); }
          20% { transform: rotate(-20deg); }
          30% { transform: rotate(15deg); }
          40% { transform: rotate(-10deg); }
          50% { transform: rotate(5deg); }
          60% { transform: rotate(0); }
          100% { transform: rotate(0); }
        }
        
        .settings-menu { 
            position: absolute; 
            top: 24px; 
            right: 24px; 
            z-index: 10; 
        }
        .settings-toggle-btn {
            background: none; border: 1px solid var(--color-neon-border);
            color: var(--color-text-secondary); width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease;
        }
        .settings-toggle-btn:hover {
            border-color: var(--color-triad-cyan); color: var(--color-triad-cyan);
            background-color: rgba(0, 210, 255, 0.1);
        }
        .settings-dropdown {
            position: absolute; top: 50px; right: 0; width: 200px;
            background-color: var(--color-surface); border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm); box-shadow: 0 4px 12px var(--color-shadow);
            padding: 8px; display: flex; flex-direction: column; gap: 4px;
            opacity: 0; transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        .settings-dropdown:not(.hidden) { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .settings-dropdown-item {
            width: 100%; padding: 10px 12px; text-align: left; background: none; border: none;
            color: var(--color-text); border-radius: 6px; font-size: 0.95rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .settings-dropdown-item:hover { background-color: var(--color-accent); color: var(--color-surface); }
        [data-theme='neon'] .settings-dropdown-item:hover { color: #000; }

        /*
         * TELA DE ONBOARDING
         */
        .onboarding-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin: 24px 0; }
        .onboarding-category-item {
            padding: 16px; border: 1px solid var(--color-neon-border);
            border-radius: var(--border-radius-sm); background: rgba(0, 0, 0, 0.4);
            color: var(--color-text-secondary); font-size: 1rem; font-weight: 500;
            text-align: center; cursor: pointer; transition: all 0.2s ease;
        }
        .onboarding-category-item:hover {
            border-color: var(--color-triad-cyan); color: var(--color-triad-cyan);
            transform: translateY(-3px); box-shadow: 0 3px 10px rgba(0, 210, 255, 0.2);
        }
        .onboarding-category-item.selected {
            background-color: var(--color-triad-cyan); color: #0d0221;
            font-weight: 600; border-color: var(--color-triad-cyan);
            box-shadow: var(--color-glow);
        }

        /*
         * INTERFACE TOOLBOX
         */
        #toolbox-section { display: flex; flex-direction: column; height: 100vh; animation: fadeIn 0.5s ease-out; }
        #main-header {
            flex-shrink: 0; position: sticky; top: 0; left: 0; right: 0; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border); z-index: 100;
            transition: background-color var(--transition-speed) ease, border-bottom var(--transition-speed) ease;
        }
        #mobile-menu-btn { display: none; background: none; border: none; color: var(--color-text); font-size: 24px; }
        .header-left, .header-right { display: flex; align-items: center; gap: 16px; }

        #category-selector, .search-bar {
            padding: 8px 12px; border-radius: var(--border-radius-sm); border: 1px solid var(--color-border);
            background-color: var(--color-bg); color: var(--color-text); transition: all 0.3s ease;
        }
        #category-selector { font-size: 1rem; font-weight: 500; max-width: 200px; }
        .search-bar { width: 250px; }
        
        #category-selector:focus, .search-bar:focus {
            outline: none; border-color: var(--color-accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 20%, transparent);
        }
        .theme-switcher, .logout-btn {
            background-color: transparent; border: 1px solid var(--color-border);
            color: var(--color-text-secondary); padding: 8px 12px; border-radius: var(--border-radius-sm);
            font-weight: 500; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 8px;
        }
        .theme-switcher:hover, .logout-btn:hover { border-color: var(--color-accent); color: var(--color-accent); }

        /*
         * PAINEL DE FERRAMENTAS (CONTEÚDO PRINCIPAL)
         */
        #tool-panel {
            flex-grow: 1; overflow-y: auto; padding: 32px;
            background-color: var(--color-bg); transition: background-color var(--transition-speed) ease;
            background-image: linear-gradient(180deg, color-mix(in srgb, var(--color-surface) 5%, transparent), transparent 20%);
        }

        #tool-panel h2.section-title {
            font-size: 1.8rem; color: var(--color-accent); margin-bottom: 24px;
            padding-bottom: 8px; border-bottom: 1px solid var(--color-border);
            text-shadow: var(--color-glow); font-weight: 600;
        }
        #tool-panel .tool-grid-container h2.section-title { margin-top: 48px; }
        
        #tutorial-section { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        #video-player-wrapper {
            position: relative; width: 100%; padding-top: 56.25%; background-color: #000;
            border-radius: var(--border-radius-md); overflow: hidden;
            border: 1px solid var(--color-border); box-shadow: 0 8px 16px var(--color-shadow);
        }
        #tutorial-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        #video-list { display: flex; flex-direction: column; gap: 12px; max-height: 450px; overflow-y: auto; padding: 4px; }
        .video-list-item {
            padding: 12px 16px; border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm); background-color: var(--color-surface);
            cursor: pointer; transition: all 0.2s ease; font-weight: 500;
            text-align: left; width: 100%; color: var(--color-text);
        }
        .video-list-item:hover {
            border-color: var(--color-accent); color: var(--color-accent); transform: translateX(4px);
        }
        .video-list-item.active {
            background-color: var(--color-accent); color: var(--color-surface);
            border-color: var(--color-accent); font-weight: 600;
        }
        [data-theme='neon'] .video-list-item.active { color: #000; box-shadow: var(--color-glow); }
        
        @keyframes card-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tool-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }
        .tool-card {
            background-color: var(--color-surface); border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md); padding: 24px; display: flex; flex-direction: column;
            gap: 12px; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            animation: card-in 0.5s ease-out forwards;
            opacity: 0;
        }
        .tool-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 25px -5px var(--color-shadow);
            border-color: var(--color-accent);
        }
        .tool-card-header { display: flex; align-items: center; gap: 16px; }
        .tool-card-header h3 { flex-grow: 1; }
        .tool-icon { font-size: 2rem; }
        .tool-card h3 { font-size: 1.2rem; color: var(--color-text); font-weight: 600; }
        .tool-card p { color: var(--color-text-secondary); font-size: 0.9rem; flex-grow: 1; line-height: 1.6; }
        .tool-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; }
        .tool-category-tag {
            background-color: color-mix(in srgb, var(--color-accent) 15%, transparent);
            color: var(--color-accent); padding: 4px 12px; border-radius: 16px;
            font-size: 0.8rem; font-weight: 500;
            border: 1px solid color-mix(in srgb, var(--color-accent) 40%, transparent);
        }
        .difficulty-indicator { display: flex; align-items: flex-end; gap: 3px; flex-shrink: 0; }
        .difficulty-indicator .bar { display: inline-block; background-color: var(--color-border); border-radius: 2px; transition: background-color 0.3s ease; }
        .difficulty-indicator .bar-1 { width: 5px; height: 8px; }
        .difficulty-indicator .bar-2 { width: 5px; height: 13px; }
        .difficulty-indicator .bar-3 { width: 5px; height: 18px; }
        .difficulty-indicator.iniciante .bar-1 { background-color: var(--color-accent); }
        .difficulty-indicator.intermediario .bar-1,
        .difficulty-indicator.intermediario .bar-2 { background-color: var(--color-accent); }
        .difficulty-indicator.avancado .bar { background-color: var(--color-accent); }

        .tool-access-btn {
            background-color: transparent; border: 1px solid var(--color-accent);
            color: var(--color-accent); padding: 8px 16px; border-radius: var(--border-radius-sm);
            font-weight: 500; text-decoration: none; transition: all 0.2s ease;
        }
        .tool-access-btn:hover { background-color: var(--color-accent-hover); color: var(--color-surface); box-shadow: var(--color-glow); }
        [data-theme='neon'] .tool-access-btn:hover { color: #000; box-shadow: var(--color-glow); }

        /*
         * VISUALIZAÇÃO DO IFRAME
         */
        #iframe-wrapper {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 500; background-color: var(--color-bg);
            display: flex; flex-direction: column; animation: fadeIn 0.4s ease;
        }
        #iframe-header {
            display: flex; align-items: center; padding: 0 24px; height: 60px;
            background-color: var(--color-surface); border-bottom: 1px solid var(--color-border);
            flex-shrink: 0; gap: 24px;
        }
        #iframe-tool-name {
            font-size: 1.2rem; font-weight: 500; color: var(--color-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #back-to-toolbox-btn, #back-to-onboarding-btn {
            background: transparent; border: 1px solid var(--color-text-secondary);
            color: var(--color-text-secondary); padding: 8px 16px; border-radius: var(--border-radius-sm);
            font-weight: 500; font-size: 0.9rem; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 8px;
        }
        #back-to-toolbox-btn:hover, #back-to-onboarding-btn:hover { border-color: var(--color-accent); color: var(--color-accent); }
        #tool-iframe { flex-grow: 1; border: none; width: 100%; height: 100%; }

        /*
         * CHAT WIDGET FLUTUANTE
         */
        #chat-widget { position: fixed; bottom: 24px; right: 24px; z-index: 1000; }
        #chat-toggle-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background-color: var(--color-accent); color: var(--color-surface);
            border: none; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px var(--color-shadow); cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease;
        }
        #chat-toggle-btn:hover { transform: scale(1.1); }
        [data-theme='neon'] #chat-toggle-btn { color: #000; box-shadow: var(--color-glow); }
        #chat-window {
            position: absolute; bottom: 80px; right: 0;
            width: 350px; max-width: calc(100vw - 48px);
            height: 500px; max-height: calc(100vh - 120px);
            background-color: var(--color-surface); border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md); box-shadow: 0 8px 24px var(--color-shadow);
            display: flex; flex-direction: column; overflow: hidden;
            transform-origin: bottom right;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            transform: scale(0.95) translateY(10px); opacity: 0;
        }
        #chat-window:not(.hidden) { transform: scale(1) translateY(0); opacity: 1; }
        .chat-header {
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background-color: var(--color-bg);
            border-bottom: 1px solid var(--color-border);
        }
        .chat-header h3 { font-size: 1.1rem; font-weight: 500; color: var(--color-accent); }
        #chat-close-btn {
            background: none; border: none; font-size: 24px; line-height: 1;
            color: var(--color-text-secondary); padding: 4px; cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #chat-close-btn:hover { color: var(--color-accent); transform: rotate(90deg); }
        .chat-body {
            flex-grow: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
        }
        .chat-placeholder {
            color: var(--color-text-secondary); text-align: center;
            margin: auto; padding: 20px;
        }
        .chat-footer {
            flex-shrink: 0; display: flex; padding: 12px;
            border-top: 1px solid var(--color-border); gap: 8px;
        }
        .chat-footer input {
            flex-grow: 1; padding: 10px; border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm); background-color: var(--color-bg);
            color: var(--color-text); outline: none; transition: border-color var(--transition-speed);
        }
        .chat-footer input:focus { border-color: var(--color-accent); }
        .chat-footer button {
            flex-shrink: 0; width: 44px; height: 44px; border: none;
            border-radius: var(--border-radius-sm); background-color: var(--color-accent);
            color: var(--color-surface); display: flex; align-items: center; justify-content: center;
            transition: background-color var(--transition-speed);
        }
        .chat-footer button:disabled { background-color: #555; cursor: not-allowed; }
        [data-theme='neon'] .chat-footer button { color: #000; }
        
        /* Estilos das Mensagens de Chat */
        .message-wrapper { display: flex; max-width: 85%; animation: fadeIn 0.3s ease; }
        .message-bubble {
            padding: 10px 14px; border-radius: 16px; line-height: 1.5;
            word-wrap: break-word; white-space: pre-wrap;
        }
        .user-wrapper { align-self: flex-end; }
        .message-bubble.user {
            background-color: var(--color-accent); color: var(--color-surface);
            border-bottom-right-radius: 4px;
        }
        [data-theme='neon'] .message-bubble.user { color: #000; }

        .assistant-wrapper { align-self: flex-start; }
        .message-bubble.assistant {
            background-color: var(--color-bg); color: var(--color-text);
            border: 1px solid var(--color-border); border-bottom-left-radius: 4px;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .message-bubble.assistant.typing::after {
            content: '▋'; animation: blink 1s step-start infinite;
            margin-left: 4px; display: inline-block;
        }
        .message-bubble.assistant.error { color: var(--color-triad-pink); border-color: var(--color-triad-pink); }

        /*
         * MODAIS
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 5, 25, 0.95); display: flex;
            justify-content: center; align-items: center; z-index: 10001;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .modal-panel {
            max-width: 500px; text-align: center;
            background: var(--color-neon-surface); border-radius: var(--border-radius-md);
            border: 1px solid var(--color-neon-border);
            padding: 32px; box-shadow: 0 8px 40px rgba(0,0,0,0.5);
        }
        .modal-header { border-bottom: none; margin-bottom: 24px; }
        .modal-header h2 { font-size: 1.6rem; margin-bottom: 16px; font-weight: 600; }
        .modal-header p { font-size: 1.1rem; color: var(--color-text-secondary); }
        #delete-confirm-modal .modal-header h2 { color: var(--color-triad-pink); text-shadow: 0 0 8px var(--color-triad-pink); }
        #edit-category-confirm-modal .modal-header h2, #change-password-confirm-modal .modal-header h2 {
            color: var(--color-triad-cyan); text-shadow: 0 0 8px var(--color-triad-cyan);
        }
        .modal-actions { display: flex; justify-content: center; gap: 16px; }
        .modal-actions .admin-btn, .modal-actions .login-btn { width: auto; min-width: 120px; }
        #confirm-delete-btn { background: var(--color-triad-pink); }
        #confirm-delete-btn:hover { background: #ff4785; box-shadow: 0 0 15px var(--color-triad-pink); }
        
        .success-toast-panel {
            padding: 24px 48px;
            background-color: var(--color-dark-accent);
            color: var(--color-dark-bg);
            border-radius: var(--border-radius-md);
            font-size: 1.2rem;
            font-weight: 600;
            box-shadow: 0 4px 20px color-mix(in srgb, var(--color-dark-accent) 40%, transparent);
            text-align: center;
            animation: fadeIn 0.3s ease;
        }
        [data-theme='light'] .success-toast-panel {
            background-color: var(--color-light-accent);
            color: var(--color-light-surface);
            box-shadow: 0 4px 20px color-mix(in srgb, var(--color-light-accent) 40%, transparent);
        }
        [data-theme='neon'] .success-toast-panel {
            background-color: var(--color-triad-cyan);
            color: var(--color-neon-bg);
            box-shadow: 0 0 25px var(--color-triad-cyan);
        }


        /*
         * RESPONSIVIDADE
         */
        @media (max-width: 992px) {
            #tutorial-section { grid-template-columns: 1fr; }
            #video-list { max-height: 250px; }
        }

        @media (max-width: 768px) {
            #main-header { padding: 0 16px; }
            .header-left .user-greeting { display: none; }
            #tool-panel { padding: 24px 16px; }
            .tool-grid { grid-template-columns: 1fr; }
            .admin-panel { padding: 24px; }
            .admin-form-grid { grid-template-columns: 1fr; }
            .onboarding-grid { grid-template-columns: 1fr; }
            .admin-panel-actions { flex-direction: column-reverse; gap: 16px; }
            .admin-panel-actions .login-btn, .admin-panel-actions .admin-btn { width: 100%; }
            #iframe-header { padding: 0 16px; gap: 16px; }
            #chat-window { width: calc(100vw - 32px); height: calc(100vh - 100px); bottom: 75px; right: -8px; }
        }
        
        /*
         * BLOQUEADOR DE DEVTOOLS (Estilo ajustado)
         */
        #devtools-blocker {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000; color: #fff; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body>

    <!-- ======================= TELA DE CARREGAMENTO ======================= -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p class="loading-text">Iniciando Sistema...</p>
    </div>

    <!-- ======================= TELA DE LOGIN USUÁRIO ======================= -->
    <main id="user-login-section" class="login-page">
        <div class="login-container">
            <img src="https://aisfizoyfpcisykarrnt.supabase.co/storage/v1/object/public/imagens/LOGO%20TRIAD3%20.png" alt="Logo Triad3" class="login-logo">
            <h1>ToolBox Triad3</h1>
            <form class="login-form" id="login-form">
                <div class="input-group">
                    <input type="email" id="email" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Senha" required>
                    <button type="button" id="toggle-password" class="toggle-password" aria-label="Mostrar senha">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-eye">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-eye-off hidden">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                        </svg>
                    </button>
                </div>
                <button type="submit" class="login-btn">Entrar</button>
                <p id="error-message" class="error-message">Email ou senha incorretos</p>
            </form>

            <div class="login-separator"><span>ou</span></div>
            
            <div class="login-actions">
                <button type="button" id="go-to-register-btn" class="admin-btn">Criar nova conta</button>
                <button type="button" id="admin-page-btn" class="switch-form-btn">🛡️ Acesso Administrativo</button>
            </div>
        </div>
    </main>

    <!-- ======================= TELA DE CADASTRO USUÁRIO ======================= -->
    <main id="user-register-section" class="login-page hidden">
        <div class="login-container">
            <img src="https://aisfizoyfpcisykarrnt.supabase.co/storage/v1/object/public/imagens/LOGO%20TRIAD3%20.png" alt="Logo Triad3" class="login-logo">
            <h1>Crie sua Conta</h1>
            <form class="login-form" id="register-form">
                <div class="input-group">
                    <input type="text" id="register-name" placeholder="Nome Completo" required>
                </div>
                <div class="input-group">
                    <input type="email" id="register-email" placeholder="Email" required>
                </div>
                <div class="input-group phone-input-container">
                    <select id="register-country-code" aria-label="Código do país" required>
                        <option value="+55" selected>🇧🇷 +55</option>
                        <option value="+1">🇺🇸 +1</option>
                        <option value="+54">🇦🇷 +54</option>
                        <option value="+351">🇵🇹 +351</option>
                        <option value="+44">🇬🇧 +44</option>
                        <option value="+49">🇩🇪 +49</option>
                        <option value="+33">🇫🇷 +33</option>
                        <option value="+81">🇯🇵 +81</option>
                    </select>
                    <input type="tel" id="register-phone" placeholder="DDD + Telefone" required>
                </div>
                <div class="input-group">
                    <input type="password" id="register-password" placeholder="Senha" required>
                    <button type="button" id="register-toggle-password" class="toggle-password" aria-label="Mostrar senha">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-eye">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-eye-off hidden">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                        </svg>
                    </button>
                </div>
                <button type="submit" class="login-btn">Cadastrar</button>
                <button type="button" id="back-to-login-btn" class="switch-form-btn">Já tem uma conta? Entrar</button>
                <p id="register-error-message" class="error-message"></p>
            </form>
        </div>
    </main>

    <!-- ======================= TELA DE LOGIN ADM ======================= -->
    <main id="admin-login-section" class="login-page hidden">
        <div class="login-container">
            <img src="https://aisfizoyfpcisykarrnt.supabase.co/storage/v1/object/public/imagens/LOGO%20TRIAD3%20.png" alt="Logo Triad3" class="login-logo">
            <h1>Login ADM</h1>
            <form class="login-form" id="admin-login-form">
                <div class="input-group">
                    <input type="email" id="admin-email" placeholder="Email do Administrador" required>
                </div>
                <div class="input-group">
                    <input type="password" id="admin-password" placeholder="Senha do Administrador" required>
                    <button type="button" id="admin-toggle-password" class="toggle-password" aria-label="Mostrar senha">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-eye">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-eye-off hidden">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                        </svg>
                    </button>
                </div>
                <button type="submit" class="login-btn">Entrar como ADM</button>
                <button type="button" id="back-to-user-btn" class="admin-btn">Voltar para Login</button>
                <p id="admin-error-message" class="error-message">Email ou senha de ADM incorretos</p>
            </form>
        </div>
    </main>
    
    <!-- ======================= PAINEL ADM - MENU DE AÇÕES ======================= -->
    <main id="admin-actions-section" class="login-page hidden">
        <div class="admin-panel" style="max-width: 600px;">
            <div class="notification-bell">
                <button id="notification-btn" class="settings-toggle-btn" aria-label="Ver notificações">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                </button>
            </div>
            <div id="admin-settings-menu" class="settings-menu">
                <button id="admin-settings-btn" class="settings-toggle-btn" aria-label="Abrir configurações">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <div id="admin-settings-dropdown" class="settings-dropdown hidden">
                    <button id="go-to-change-password-btn" class="settings-dropdown-item">Alterar Senha</button>
                    <button id="go-to-add-new-admin-btn" class="settings-dropdown-item">Adicionar Novo ADM</button>
                </div>
            </div>

            <div class="admin-panel-header">
                <h2>Painel Administrativo</h2>
                <p>O que você gostaria de fazer?</p>
            </div>
            <div class="admin-action-buttons">
                <button id="go-to-add-tool-btn" class="login-btn">Adicionar uma nova ferramenta</button>
                <button id="go-to-edit-tool-btn" class="login-btn">Editar Uma Ferramenta</button>
                <button id="go-to-delete-tool-btn" class="login-btn">Excluir uma ferramenta</button>
            </div>
            <div class="admin-panel-footer" style="border-top: none; margin-top: 0; padding-top: 0;">
                 <div class="admin-panel-actions" style="justify-content: center;">
                     <button type="button" id="admin-logout-btn" class="admin-btn secondary" style="width: 50%;">Sair</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ======================= PAINEL ADM - LISTA DE ESPERA ======================= -->
    <main id="waiting-list-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Novos Usuários na Lista de Espera</h2>
                <p id="waiting-list-empty-message" class="hidden" style="color: var(--color-text-secondary); margin-top: 16px;">No momento, não há nenhum novo usuário na lista de espera.</p>
            </div>
            <div id="waiting-list-container">
                <!-- Lista de usuários será inserida aqui pelo JS -->
            </div>
            <div class="admin-panel-footer">
                <div class="admin-panel-actions">
                    <button type="button" id="back-to-admin-menu-from-waitlist-btn" class="admin-btn secondary">&larr; Voltar</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ======================= PAINEL ADM - ALTERAR SENHA ======================= -->
    <main id="admin-change-password-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Alterar Senha</h2>
                <p>Preencha os dados para alterar sua senha de administrador.</p>
            </div>
            <form id="change-password-form">
                <div class="form-group full-width">
                    <label for="change-password-email">Seu Email de Administrador</label>
                    <input type="email" id="change-password-email" required>
                </div>
                <div class="form-group full-width">
                    <label for="change-password-new">Nova Senha</label>
                    <input type="password" id="change-password-new" required>
                </div>
                <div class="admin-panel-footer">
                    <div class="admin-panel-actions">
                        <button type="button" id="back-to-admin-menu-from-password-btn" class="admin-btn secondary">&larr; Voltar</button>
                        <button type="submit" id="save-new-password-btn" class="login-btn">Salvar Nova Senha</button>
                    </div>
                </div>
            </form>
        </div>
    </main>
    
    <!-- ======================= PAINEL ADM - ADICIONAR NOVO ADM ======================= -->
    <main id="add-new-admin-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Adicionar Novo ADM</h2>
                <p>Preencha os dados para cadastrar um novo administrador.</p>
            </div>
            <form id="add-new-admin-form">
                <div class="form-group full-width">
                    <label for="add-admin-name">Nome</label>
                    <input type="text" id="add-admin-name" placeholder="Nome completo do administrador" required>
                </div>
                <div class="form-group full-width">
                    <label for="add-admin-email">E-mail</label>
                    <input type="email" id="add-admin-email" placeholder="email@exemplo.com" required>
                </div>
                <div class="form-group full-width">
                    <label for="add-admin-password">Senha</label>
                    <input type="password" id="add-admin-password" placeholder="Crie uma senha forte" required>
                </div>
                <div class="admin-panel-footer">
                    <p id="add-admin-error-message" class="error-message"></p>
                    <div class="admin-panel-actions">
                        <button type="button" id="back-to-admin-menu-from-add-admin-btn" class="admin-btn secondary">&larr; Voltar</button>
                        <button type="submit" id="add-new-admin-btn" class="login-btn">Cadastrar Novo ADM</button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- ======================= PAINEL ADM - SELECIONAR FERRAMENTA PARA EDITAR ======================= -->
    <main id="edit-tool-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <div>
                    <h2>Editar Ferramenta</h2>
                    <p>Qual Ferramenta Você Gostaria De Editar?</p>
                </div>
                <button id="go-to-edit-category-btn" class="admin-btn">Editar Categorias</button>
            </div>
            <div id="edit-tool-list">
                <!-- Lista de ferramentas para editar será inserida aqui -->
            </div>
            <div class="admin-panel-footer">
                <div class="admin-panel-actions">
                    <button type="button" id="back-to-admin-menu-from-edit-btn" class="admin-btn secondary">&larr; Voltar</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ======================= PAINEL ADM - SELECIONAR CATEGORIA PARA EDITAR ======================= -->
    <main id="edit-category-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Editar Categoria</h2>
                <p>Selecione a categoria que deseja editar.</p>
            </div>
            <div id="edit-category-list">
                <!-- Lista de categorias será inserida aqui -->
            </div>
            <div class="admin-panel-footer">
                <div class="admin-panel-actions">
                    <button type="button" id="back-to-edit-tool-section-btn" class="admin-btn secondary">&larr; Voltar</button>
                </div>
            </div>
        </div>
    </main>
    
     <!-- ======================= PAINEL ADM - FORMULÁRIO DE EDIÇÃO DE CATEGORIA ======================= -->
    <main id="edit-category-form-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Editar Categoria: <span id="editing-category-name" style="color: var(--color-text);"></span></h2>
                <p>Altere o nome da categoria abaixo.</p>
            </div>
            <form id="edit-category-form">
                <div class="form-group full-width">
                    <label for="new-category-name-input">Novo nome da categoria</label>
                    <input type="text" id="new-category-name-input" required>
                </div>
                <div class="admin-panel-footer">
                    <div class="admin-panel-actions">
                        <button type="button" id="back-to-category-list-btn" class="admin-btn secondary">&larr; Voltar</button>
                        <button type="submit" id="save-category-btn" class="login-btn" disabled>Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </main>
    
    <!-- ======================= PAINEL ADM - SELECIONAR FERRAMENTA PARA EXCLUIR ======================= -->
    <main id="delete-tool-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Excluir Ferramenta</h2>
                <p>Qual ferramenta você gostaria de excluir?</p>
            </div>
            <div id="delete-tool-list">
                <!-- Lista de ferramentas para excluir será inserida aqui -->
            </div>
            <div class="admin-panel-footer">
                <div class="admin-panel-actions">
                    <button type="button" id="back-to-admin-menu-from-delete-btn" class="admin-btn secondary">&larr; Voltar</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ======================= PAINEL ADM - FORMULÁRIO DE EDIÇÃO DE FERRAMENTA ======================= -->
    <main id="edit-tool-form-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Editar: <span id="editing-tool-name" style="color: var(--color-text);"></span></h2>
                <p>Altere os dados abaixo para modificar a ferramenta.</p>
            </div>
            <form id="edit-tool-form">
                <input type="hidden" id="edit-tool-id">
                <div class="admin-form-grid">
                    <div class="form-group full-width">
                        <label for="edit-tool-name">Nome da Ferramenta</label>
                        <input type="text" id="edit-tool-name" required>
                    </div>
                     <div class="form-group full-width">
                        <label for="edit-tool-link">Link da Ferramenta</label>
                        <input type="url" id="edit-tool-link" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-tool-difficulty">Nível de Dificuldade</label>
                        <select id="edit-tool-difficulty" required>
                            <option value="Iniciante">Iniciante</option>
                            <option value="Intermediário">Intermediário</option>
                            <option value="Avançado">Avançado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-tool-status">Status da Ferramenta</label>
                        <div class="status-toggle-container">
                            <label class="status-toggle">
                                <input type="checkbox" id="edit-tool-status">
                                <span class="slider round"></span>
                            </label>
                            <span id="edit-tool-status-text">Inativo</span>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="edit-tool-video">Link do Vídeo Tutorial (Opcional)</label>
                        <input type="url" id="edit-tool-video">
                    </div>

                    <div class="form-group full-width" style="position: relative;">
                        <label>Ícone da Ferramenta</label>
                        <div id="edit-emoji-input-container">
                            <span id="edit-selected-emoji">❓</span>
                            <button type="button" id="edit-emoji-select-btn">Escolha um Ícone</button>
                        </div>
                        <input type="hidden" id="edit-tool-emoji" required>
                        <div id="edit-emoji-picker" class="hidden">
                            <!-- Emojis são populados via JS -->
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="edit-tool-description">Descrição</label>
                        <textarea id="edit-tool-description" rows="4" required></textarea>
                    </div>
                </div>

                <div class="admin-panel-footer">
                    <p id="edit-tool-success-message" class="success-message"></p>
                    <div class="admin-panel-actions">
                        <button type="button" id="back-to-edit-list-btn" class="admin-btn secondary">&larr; Voltar</button>
                        <button type="submit" id="save-tool-btn" class="login-btn" disabled>Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- ======================= PAINEL ADMINISTRATIVO - ADICIONAR FERRAMENTA ======================= -->
    <main id="admin-panel-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2>Adicionar Nova Ferramenta</h2>
                <p>Preencha os dados abaixo para cadastrar uma nova ferramenta na ToolBox Triad3.</p>
            </div>
            <form id="add-tool-form">
                <div class="admin-form-grid">
                    <div class="form-group">
                        <label for="tool-name">Nome da Ferramenta</label>
                        <input type="text" id="tool-name" placeholder="Ex: Previsor de Cenários" required>
                    </div>
                    <div class="form-group">
                        <label for="tool-link">Link da Ferramenta</label>
                        <input type="url" id="tool-link" placeholder="https://exemplo.com" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="tool-video">Link do Vídeo Tutorial (Opcional)</label>
                        <input type="url" id="tool-video" placeholder="https://youtube.com/watch?v=...">
                    </div>

                    <div class="form-group">
                        <label>Categoria</label>
                        <input type="hidden" id="tool-category-value" required>
                        <div id="category-display" class="category-display-box">
                            <span id="selected-category-text">Nenhuma categoria selecionada</span>
                        </div>
                        <div class="category-actions">
                            <button type="button" id="btn-create-category" class="admin-btn">Criar Nova</button>
                            <button type="button" id="btn-select-category" class="admin-btn">Selecionar Existente</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tool-difficulty">Nível de Dificuldade</label>
                        <select id="tool-difficulty" required>
                            <option value="" disabled selected>Escolha o nível...</option>
                            <option value="Iniciante">Iniciante</option>
                            <option value="Intermediário">Intermediário</option>
                            <option value="Avançado">Avançado</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width hidden" id="new-category-group">
                        <label for="new-category-name">Nome da Nova Categoria</label>
                        <input type="text" id="new-category-name" placeholder="Ex: Recursos Humanos">
                    </div>
                    
                    <div class="form-group full-width hidden" id="select-category-group">
                        <label for="existing-category-select">Selecione uma Categoria</label>
                        <select id="existing-category-select">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    
                    <div class="form-group full-width" style="position: relative;">
                        <label>Ícone da Ferramenta</label>
                        <div id="emoji-input-container">
                            <span id="selected-emoji">❓</span>
                            <button type="button" id="emoji-select-btn">Escolha um Ícone</button>
                        </div>
                        <input type="hidden" id="tool-emoji" required>
                        <div id="emoji-picker" class="hidden">
                            <!-- Emojis são populados via JS -->
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="tool-description">Descrição</label>
                        <textarea id="tool-description" placeholder="Uma breve descrição sobre a funcionalidade da ferramenta." rows="4" required></textarea>
                    </div>
                </div>

                <div class="admin-panel-footer">
                    <div class="progress-bar-container">
                        <div id="form-progress-bar" class="progress-bar-fill"></div>
                    </div>
                    <p id="add-tool-success-message" class="success-message"></p>
                    <div class="admin-panel-actions">
                        <button type="button" id="back-to-admin-menu-btn" class="admin-btn secondary">&larr; Voltar</button>
                        <button type="submit" id="add-tool-btn" class="login-btn" disabled>Adicionar Ferramenta</button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- ======================= TELA DE ONBOARDING ======================= -->
    <main id="onboarding-section" class="login-page hidden">
        <div class="admin-panel">
            <div class="admin-panel-header">
                <h2 id="onboarding-greeting">Olá!</h2>
                <p>
                    Quais as principais áreas que deseja configurar a sua Toolbox?
                </p>
            </div>
            <div id="onboarding-category-grid" class="onboarding-grid">
                <!-- Categorias serão inseridas aqui pelo JS -->
            </div>
            <div class="admin-panel-footer">
                 <div class="admin-panel-actions" style="justify-content: center;">
                    <button id="onboarding-continue-btn" class="login-btn" style="width: 50%;" disabled>Criar ToolBox</button>
                </div>
            </div>
        </div>
    </main>


    <!-- ======================= INTERFACE TOOLBOX ======================= -->
    <div id="toolbox-section" class="hidden">
        
        <!-- CABEÇALHO -->
        <header id="main-header">
            <div class="header-left">
                <button id="mobile-menu-btn" aria-label="Abrir menu" style="display: none;">&#9776;</button>
                <button id="back-to-onboarding-btn" title="Criar nova ToolBox">&larr; Voltar</button>
                <select id="category-selector" class="hidden"></select>
                <h1 class="user-greeting" style="font-size: 1.2rem; font-weight: 500;">Olá!</h1>
            </div>
            <div class="header-right">
                <input type="search" id="search-bar" class="search-bar" placeholder="Buscar ferramenta...">
                <button id="theme-switcher" class="theme-switcher" title="Alternar tema">
                    <span id="theme-icon">🌙</span>
                </button>
                <button id="logout-btn" class="logout-btn">Sair</button>
            </div>
        </header>

        <!-- CONTEÚDO PRINCIPAL (GERADO DINAMICAMENTE) -->
        <main id="tool-panel">
            <!-- O conteúdo da categoria (tutoriais e ferramentas) será inserido aqui pelo JS -->
        </main>
    </div>

    <!-- ======================= IFRAME VIEW ======================= -->
    <div id="iframe-wrapper" class="hidden">
        <header id="iframe-header">
            <button id="back-to-toolbox-btn" title="Voltar para a lista de ferramentas">
                &larr; Voltar
            </button>
            <h2 id="iframe-tool-name"></h2>
        </header>
        <iframe id="tool-iframe" src="about:blank" title="Ferramenta Externa" allow="fullscreen"></iframe>
    </div>

    <!-- ======================= CHAT WIDGET ======================= -->
    <div id="chat-widget" class="hidden">
        <div id="chat-window" class="hidden">
            <div class="chat-header">
                <h3>Assistente Virtual</h3>
                <button id="chat-close-btn" aria-label="Fechar chat">&times;</button>
            </div>
            <div id="chat-body" class="chat-body">
                <!-- Mensagens do chat irão aqui -->
            </div>
            <div class="chat-footer">
                <input type="text" id="chat-input" placeholder="Digite sua mensagem...">
                <button id="chat-send-btn" aria-label="Enviar mensagem">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
        <button id="chat-toggle-btn" aria-label="Abrir chat">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        </button>
    </div>

    <!-- ======================= MODAIS DE CONFIRMAÇÃO ======================= -->
    <div id="delete-confirm-modal" class="modal-overlay hidden">
        <div class="modal-panel">
            <div class="modal-header">
                <h2>Confirmar Exclusão</h2>
                <p id="delete-confirm-text">Você tem certeza que quer excluir esta ferramenta permanentemente?</p>
            </div>
            <div class="modal-actions">
                <button id="cancel-delete-btn" class="admin-btn secondary">Cancelar</button>
                <button id="confirm-delete-btn" class="login-btn">Confirmar Exclusão</button>
            </div>
            <p id="delete-tool-success-message" class="success-message" style="margin-top: 24px;"></p>
        </div>
    </div>
    
    <div id="edit-category-confirm-modal" class="modal-overlay hidden">
        <div class="modal-panel">
            <div class="modal-header">
                <h2>Confirmar Alteração</h2>
                <p id="edit-category-confirm-text"></p>
            </div>
            <div class="modal-actions">
                <button id="cancel-edit-category-btn" class="admin-btn secondary">Cancelar</button>
                <button id="confirm-edit-category-btn" class="login-btn">Confirmar</button>
            </div>
            <p id="edit-category-success-message" class="success-message" style="margin-top: 24px;"></p>
        </div>
    </div>
    
    <div id="change-password-confirm-modal" class="modal-overlay hidden">
        <div class="modal-panel">
            <div class="modal-header">
                <h2>Confirmar Alteração de Senha</h2>
                <p id="change-password-confirm-text">Você tem certeza que quer alterar sua senha?</p>
            </div>
            <div class="modal-actions">
                <button id="cancel-change-password-btn" class="admin-btn secondary">Cancelar</button>
                <button id="confirm-change-password-btn" class="login-btn">Confirmar</button>
            </div>
            <p id="change-password-success-message" class="success-message" style="margin-top: 24px;"></p>
        </div>
    </div>
    
    <div id="success-redirect-modal" class="modal-overlay hidden">
        <div class="modal-panel" style="text-align: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--color-dark-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 24px;">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <div class="modal-header" style="padding: 0; margin-bottom: 0;">
                 <p id="success-redirect-message" style="font-size: 1rem; line-height: 1.6; color: var(--color-text-secondary);"></p>
            </div>
        </div>
    </div>

    <div id="user-details-modal" class="modal-overlay hidden">
        <div class="modal-panel" style="max-width: 450px;">
            <!-- Initial Details View -->
            <div id="user-detail-initial-view">
                <div class="modal-header" style="margin-bottom: 16px;">
                    <h2 id="user-detail-name" style="color: var(--color-triad-cyan); text-shadow: 0 0 8px var(--color-triad-cyan);"></h2>
                </div>
                <div id="user-detail-content" style="text-align: left; color: var(--color-text); line-height: 1.8; font-size: 1rem; margin-bottom: 24px;">
                    <p><strong>Email:</strong> <span id="user-detail-email" style="color: var(--color-text-secondary);"></span></p>
                    <p><strong>Telefone:</strong> <span id="user-detail-phone" style="color: var(--color-text-secondary);"></span></p>
                </div>
                <div class="modal-actions">
                    <button id="close-user-detail-modal-btn" class="admin-btn secondary">Fechar</button>
                    <button id="approve-user-start-btn" class="login-btn">Aprovar Usuário</button>
                </div>
            </div>

            <!-- Approval Flow View -->
            <div id="user-detail-approval-view" class="hidden">
                <div class="modal-header">
                    <h2>Nível de Acesso</h2>
                    <p>Qual nível de acesso este usuário terá?</p>
                </div>
                <div id="access-level-selection" class="modal-actions" style="flex-direction: column; gap: 12px; margin: 24px 0; width: 100%;">
                    <button class="login-btn access-level-btn" data-level="Iniciante" style="width: 100%;">Iniciante</button>
                    <button class="login-btn access-level-btn" data-level="Intermediário" style="width: 100%;">Intermediário</button>
                    <button class="login-btn access-level-btn" data-level="Avançado" style="width: 100%;">Avançado</button>
                </div>
                <div id="confirm-access-selection" class="hidden">
                     <p style="margin-bottom: 24px; color: var(--color-text-secondary);">Nível selecionado: <strong id="selected-access-level" style="color: var(--color-text);"></strong></p>
                     <div class="modal-actions">
                        <button id="back-to-level-selection-btn" class="admin-btn secondary">Voltar</button>
                        <button id="confirm-access-btn" class="login-btn">Confirmar Acesso</button>
                     </div>
                </div>
            </div>

            <!-- Success/Error Message Area -->
            <p id="user-approval-message" class="success-message" style="margin-top: 24px;"></p>
        </div>
    </div>
    
    <div id="success-toast" class="modal-overlay hidden">
        <div class="success-toast-panel">
            <p id="success-toast-message"></p>
        </div>
    </div>


<script>
  // BLOQUEIO DE TECLAS COMUNS DO DEVTOOLS
  document.addEventListener('keydown', function (e) {
    if (
      e.key === 'F12' ||
      (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') ||
      (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'j') ||
      (e.ctrlKey && e.key.toLowerCase() === 'u') ||
      (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'c')
    ) {
      e.preventDefault();
      document.body.innerHTML = '<div id="devtools-blocker"><h1>ACESSO RESTRITO</h1></div>';
    }
  });

  // IMPEDIR CLIQUE DIREITO
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });

  // DETECÇÃO DE DEVTOOLS PELO TAMANHO DA JANELA
  setInterval(function () {
    if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
      if (!document.getElementById('devtools-blocker')) {
          document.body.innerHTML = '<div id="devtools-blocker"><h1>ACESSO RESTRITO</h1></div>';
      }
    }
  }, 1000);
</script>

    <script type="module">
        import { GoogleGenAI } from 'https://esm.run/@google/genai';

        document.addEventListener('DOMContentLoaded', () => {

            // ======================= DADOS E VARIÁVEIS GLOBAIS =======================
            let allTools = []; // Armazena todas as ferramentas da API
            let activeTools = []; // Ferramentas das categorias selecionadas pelo usuário
            let selectedCategories = []; // Nomes das categorias selecionadas
            let toolToDelete = null; // Armazena a ferramenta a ser excluída
            let categoryToEdit = null; // Armazena a categoria a ser editada
            let newUsersList = []; // Armazena a lista de novos usuários da lista de espera
            let currentUserForApproval = null; // Armazena o usuário sendo aprovado

            const themes = ['dark', 'light', 'neon'];
            const themeIcons = { dark: '🌙', light: '☀️', neon: '👽' };
            const emojiList = [
                '📈', '📉', '📊', '💹', '💰', '💸', '💵', '💶', '💷', '💴', '💳', '🏦', '💼', '🧾', '⚖️',
                '🤖', '🧠', '⚙️', '🔌', '💡', '📡', '🛰️', '🚀', '💻', '🖥️', '📱', '⌚', '💾', '💿', '🖱️',
                '📢', '📣', '🔔', '📧', '✉️', '🎯', '🌐', '🔗', '📞', '☎️', '📠', '🗣️', '💬', '✍️', '📝', '🖌️',
                '🔧', '🔨', '🔩', '🛠️', '🔑', '🔓', '🔐', '🧰', '📎', '📌', '📏', '📐', '✂️', '🗂️', '📂',
                '📁', '📄', '📜', '📑', '📆', '📅', '📋', '🗒️', '✅', '✔️', '❌',
                '🤔', '🗺️', '🧭', '♟️', '🎲', '🧩', '🔮', '✨',
                '🛡️', '🔒', '🚨', '🚦', '🚧',
                '🔬', '🔭', '⚗️', '🧬', '🧪', '🔢', '🧮',
                '👥', '👤', '🤝', '🧑‍💻', '👨‍💼', '👩‍💼', '🧑‍🏫', '👨‍🏫', '👩‍🏫',
                '⭐', '🌟', '❓', '❕', '➡️', '⬅️', '⬆️', '⬇️', '♻️', '🌍', '🏠', '🏢', '🎥', '🔦'
            ];

            // ======================= SELETORES DE ELEMENTOS =======================
            const userLoginSection = document.getElementById('user-login-section');
            const userRegisterSection = document.getElementById('user-register-section');
            const adminLoginSection = document.getElementById('admin-login-section');
            const adminActionsSection = document.getElementById('admin-actions-section');
            const waitingListSection = document.getElementById('waiting-list-section');
            const adminPanelSection = document.getElementById('admin-panel-section');
            const editToolSection = document.getElementById('edit-tool-section');
            const editCategorySection = document.getElementById('edit-category-section');
            const editCategoryFormSection = document.getElementById('edit-category-form-section');
            const editToolFormSection = document.getElementById('edit-tool-form-section');
            const deleteToolSection = document.getElementById('delete-tool-section');
            const toolboxSection = document.getElementById('toolbox-section');
            const loadingOverlay = document.getElementById('loading-overlay');
            const iframeWrapper = document.getElementById('iframe-wrapper');
            const onboardingSection = document.getElementById('onboarding-section');
            const adminChangePasswordSection = document.getElementById('admin-change-password-section');
            const addNewAdminSection = document.getElementById('add-new-admin-section');
            
            // Forms
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const adminLoginForm = document.getElementById('admin-login-form');
            const addToolForm = document.getElementById('add-tool-form');
            const changePasswordForm = document.getElementById('change-password-form');
            const addNewAdminForm = document.getElementById('add-new-admin-form');
            
            // Inputs e Botões de Login/Registro
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const togglePasswordBtn = document.getElementById('toggle-password');
            const goToRegisterBtn = document.getElementById('go-to-register-btn');
            const backToLoginBtn = document.getElementById('back-to-login-btn');
            const registerPasswordInput = document.getElementById('register-password');
            const registerTogglePasswordBtn = document.getElementById('register-toggle-password');
            const adminEmailInput = document.getElementById('admin-email');
            const adminPasswordInput = document.getElementById('admin-password');
            const adminTogglePasswordBtn = document.getElementById('admin-toggle-password');
            
            // Mensagens
            const errorMessage = document.getElementById('error-message');
            const adminErrorMessage = document.getElementById('admin-error-message');
            const addToolSuccessMessage = document.getElementById('add-tool-success-message');
            const registerErrorMessage = document.getElementById('register-error-message');
            const addAdminErrorMessage = document.getElementById('add-admin-error-message');

            // Onboarding
            const onboardingGreeting = document.getElementById('onboarding-greeting');
            const onboardingCategoryGrid = document.getElementById('onboarding-category-grid');
            const onboardingContinueBtn = document.getElementById('onboarding-continue-btn');

            // Toolbox
            const logoutBtn = document.getElementById('logout-btn');
            const toolPanel = document.getElementById('tool-panel');
            const searchBar = document.getElementById('search-bar');
            const themeSwitcher = document.getElementById('theme-switcher');
            const themeIcon = document.getElementById('theme-icon');
            const userGreeting = document.querySelector('.user-greeting');
            const backToOnboardingBtn = document.getElementById('back-to-onboarding-btn');
            const categorySelector = document.getElementById('category-selector');
            
            // Iframe View
            const toolIframe = document.getElementById('tool-iframe');
            const backToToolboxBtn = document.getElementById('back-to-toolbox-btn');
            const iframeToolName = document.getElementById('iframe-tool-name');

            // Admin Panel
            const goToAddToolBtn = document.getElementById('go-to-add-tool-btn');
            const goToEditToolBtn = document.getElementById('go-to-edit-tool-btn');
            const goToDeleteToolBtn = document.getElementById('go-to-delete-tool-btn');
            const backToAdminMenuBtn = document.getElementById('back-to-admin-menu-btn');
            const backToAdminMenuFromEditBtn = document.getElementById('back-to-admin-menu-from-edit-btn');
            const backToAdminMenuFromDeleteBtn = document.getElementById('back-to-admin-menu-from-delete-btn');
            const editToolList = document.getElementById('edit-tool-list');
            const deleteToolList = document.getElementById('delete-tool-list');
            const toolNameInput = document.getElementById('tool-name');
            const toolLinkInput = document.getElementById('tool-link');
            const toolVideoInput = document.getElementById('tool-video');
            const toolDifficultySelect = document.getElementById('tool-difficulty');
            const toolDescriptionTextarea = document.getElementById('tool-description');
            const toolEmojiInput = document.getElementById('tool-emoji');
            const emojiSelectBtn = document.getElementById('emoji-select-btn');
            const selectedEmojiSpan = document.getElementById('selected-emoji');
            const emojiPicker = document.getElementById('emoji-picker');
            const addToolBtn = document.getElementById('add-tool-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const formProgressBar = document.getElementById('form-progress-bar');
            const toolCategoryValueInput = document.getElementById('tool-category-value');
            const categoryDisplay = document.getElementById('category-display');
            const selectedCategoryText = document.getElementById('selected-category-text');
            const btnCreateCategory = document.getElementById('btn-create-category');
            const btnSelectCategory = document.getElementById('btn-select-category');
            const newCategoryGroup = document.getElementById('new-category-group');
            const selectCategoryGroup = document.getElementById('select-category-group');
            const newCategoryNameInput = document.getElementById('new-category-name');
            const existingCategorySelect = document.getElementById('existing-category-select');
            
            // Admin Panel - Settings Menu
            const adminSettingsMenu = document.getElementById('admin-settings-menu');
            const adminSettingsBtn = document.getElementById('admin-settings-btn');
            const adminSettingsDropdown = document.getElementById('admin-settings-dropdown');
            const goToChangePasswordBtn = document.getElementById('go-to-change-password-btn');
            const goToAddAdminBtnBtn = document.getElementById('go-to-add-new-admin-btn');
            
            // Admin Panel - Change Password
            const backToAdminMenuFromPasswordBtn = document.getElementById('back-to-admin-menu-from-password-btn');
            const changePasswordConfirmModal = document.getElementById('change-password-confirm-modal');
            const cancelChangePasswordBtn = document.getElementById('cancel-change-password-btn');
            const confirmChangePasswordBtn = document.getElementById('confirm-change-password-btn');
            const changePasswordSuccessMessage = document.getElementById('change-password-success-message');

            // Admin Panel - Add New Admin
            const backToAdminMenuFromAddAdminBtn = document.getElementById('back-to-admin-menu-from-add-admin-btn');

            // Admin Panel - Edit Category
            const goToEditCategoryBtn = document.getElementById('go-to-edit-category-btn');
            const editCategoryList = document.getElementById('edit-category-list');
            const backToEditToolSectionBtn = document.getElementById('back-to-edit-tool-section-btn');
            const editCategoryForm = document.getElementById('edit-category-form');
            const editingCategoryNameSpan = document.getElementById('editing-category-name');
            const newCategoryNameInputForEdit = document.getElementById('new-category-name-input');
            const saveCategoryBtn = document.getElementById('save-category-btn');
            const backToCategoryListBtn = document.getElementById('back-to-category-list-btn');
            const editCategoryConfirmModal = document.getElementById('edit-category-confirm-modal');
            const editCategoryConfirmText = document.getElementById('edit-category-confirm-text');
            const cancelEditCategoryBtn = document.getElementById('cancel-edit-category-btn');
            const confirmEditCategoryBtn = document.getElementById('confirm-edit-category-btn');
            const editCategorySuccessMessage = document.getElementById('edit-category-success-message');

            // Admin Panel - Waiting List
            const notificationBtn = document.getElementById('notification-btn');
            const waitingListContainer = document.getElementById('waiting-list-container');
            const waitingListEmptyMessage = document.getElementById('waiting-list-empty-message');
            const backToAdminMenuFromWaitlistBtn = document.getElementById('back-to-admin-menu-from-waitlist-btn');
            const userDetailsModal = document.getElementById('user-details-modal');
            const userDetailName = document.getElementById('user-detail-name');
            const userDetailEmail = document.getElementById('user-detail-email');
            const userDetailPhone = document.getElementById('user-detail-phone');
            const closeUserDetailModalBtn = document.getElementById('close-user-detail-modal-btn');
            const approveUserStartBtn = document.getElementById('approve-user-start-btn');
            const userDetailInitialView = document.getElementById('user-detail-initial-view');
            const userDetailApprovalView = document.getElementById('user-detail-approval-view');
            const accessLevelSelection = document.getElementById('access-level-selection');
            const confirmAccessSelection = document.getElementById('confirm-access-selection');
            const selectedAccessLevelSpan = document.getElementById('selected-access-level');
            const backToLevelSelectionBtn = document.getElementById('back-to-level-selection-btn');
            const confirmAccessBtn = document.getElementById('confirm-access-btn');
            const userApprovalMessage = document.getElementById('user-approval-message');

            // Admin Panel - Edit Form
            const editToolForm = document.getElementById('edit-tool-form');
            const editingToolNameSpan = document.getElementById('editing-tool-name');
            const editToolIdInput = document.getElementById('edit-tool-id');
            const editToolNameInput = document.getElementById('edit-tool-name');
            const editToolLinkInput = document.getElementById('edit-tool-link');
            const editToolVideoInput = document.getElementById('edit-tool-video');
            const editToolDifficultySelect = document.getElementById('edit-tool-difficulty');
            const editToolDescriptionTextarea = document.getElementById('edit-tool-description');
            const editToolEmojiInput = document.getElementById('edit-tool-emoji');
            const editEmojiSelectBtn = document.getElementById('edit-emoji-select-btn');
            const editSelectedEmojiSpan = document.getElementById('edit-selected-emoji');
            const editEmojiPicker = document.getElementById('edit-emoji-picker');
            const backToEditListBtn = document.getElementById('back-to-edit-list-btn');
            const saveToolBtn = document.getElementById('save-tool-btn');
            const editToolSuccessMessage = document.getElementById('edit-tool-success-message');
            const editToolStatusCheckbox = document.getElementById('edit-tool-status');
            const editToolStatusText = document.getElementById('edit-tool-status-text');

            // Modals
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmText = document.getElementById('delete-confirm-text');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const deleteToolSuccessMessage = document.getElementById('delete-tool-success-message');
            const successRedirectModal = document.getElementById('success-redirect-modal');
            const successToast = document.getElementById('success-toast');
            const successToastMessage = document.getElementById('success-toast-message');

            // Chat Widget
            const chatWidget = document.getElementById('chat-widget');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatWindow = document.getElementById('chat-window');
            const chatHeader = chatWindow.querySelector('.chat-header');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatBody = document.getElementById('chat-body');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            // ======================= LÓGICA DO CHAT COM GEMINI =======================
            let ai;
            let chat;
            let isChatInProgress = false;
            let currentChatContext = null;
            const GEMINI_API_KEY = "AIzaSyDhh-NH-fICn7zYXG2QmiQKiT3IhiOOXVA";

            function appendMessage(sender, text, isTyping = false) {
                const placeholder = chatBody.querySelector('.chat-placeholder');
                if (placeholder) placeholder.remove();

                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message-wrapper ${sender}-wrapper`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `message-bubble ${sender}`;
                messageBubble.textContent = text;
                
                if (isTyping) {
                    messageBubble.classList.add('typing');
                }

                messageWrapper.appendChild(messageBubble);
                chatBody.appendChild(messageWrapper);
                chatBody.scrollTop = chatBody.scrollHeight;
                
                return messageBubble;
            }

            async function initChat() {
                const isOnboarding = !onboardingSection.classList.contains('hidden');
                const isToolbox = !toolboxSection.classList.contains('hidden');
                let newContext = null;

                if (isOnboarding) newContext = 'onboarding';
                else if (isToolbox) newContext = 'toolbox';
                else return;

                // Não reinicializa se o contexto não mudou (exceto para toolbox, que precisa ser dinâmico)
                if (chat && currentChatContext === newContext && newContext !== 'toolbox') return;

                currentChatContext = newContext;
                chatBody.innerHTML = ''; 
                isChatInProgress = false;
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                
                if (!ai) {
                    ai = new GoogleGenAI({apiKey: GEMINI_API_KEY});
                }

                let systemInstruction = '';
                const userName = localStorage.getItem('userName') || 'usuário';

                if (newContext === 'onboarding') {
                    const toolKnowledge = allTools.map(tool =>
                        `- Categoria: "${tool.category}"\n  - Ferramenta: "${tool.name}"\n  - Descrição: ${tool.description}`
                    ).join('\n\n');

                    systemInstruction = `Você é um assistente especialista da ToolBox Triad3, um consultor amigável e estratégico.
Sua única missão é ajudar o usuário, chamado ${userName}, a montar a toolbox personalizada para resolver os problemas da empresa dele.

**Seu Conhecimento (Ferramentas Disponíveis):**
Você tem acesso a todas as categorias e ferramentas do sistema. Aqui está a sua base de conhecimento:
---
${toolKnowledge}
---

**Suas Diretrizes de Comportamento:**
1.  **Personalidade:** Seja humano, pessoal и empático. Chame o usuário pelo nome (${userName}). Use uma linguagem natural e evite ser robótico. Utilize quebras de linha para formatar respostas longas e facilitar a leitura.
2.  **Foco na Solução:** Ouça atentamente os problemas, "dores" ou objetivos que ${userName} descrever (ex: "preciso melhorar as vendas", "quero organizar o RH").
3.  **Recomendações Precisas:** Com base no problema descrito, use seu conhecimento para recomendar as CATEGORIAS mais relevantes que ele deve selecionar na tela. Justifique suas recomendações mencionando brevemente quais ferramentas naquela categoria podem ajudar.
4.  **Mantenha o Objetivo:** Seu objetivo final é guiar o usuário para que ele SELECIONE as categorias. Você não executa as ferramentas, apenas aconselha sobre quais categorias escolher.
5.  **Não Desvie do Assunto:** Se ${userName} perguntar sobre qualquer outra coisa (quem te criou, o clima, etc.), gentilmente redirecione a conversa para o objetivo principal. Diga algo como: "Essa é uma ótima pergunta! Mas para montarmos a melhor toolbox para você, vamos focar nos seus desafios primeiro, que tal, ${userName}?"`;
                    
                    chatHeader.querySelector('h3').textContent = 'Assistente de Onboarding';
                    appendMessage('assistant', `Olá, ${userName}! Sou seu assistente de configuração. Para começar, me diga: quais desafios ou 'dores' você gostaria de resolver na sua empresa? Com base nisso, posso te ajudar a selecionar as melhores categorias de ferramentas.`);

                } else { // Contexto 'toolbox'
                    const activeCategory = categorySelector.value || (selectedCategories.length > 0 ? selectedCategories[0] : '');
                    
                    if (!activeCategory) {
                        chatHeader.querySelector('h3').textContent = 'Assistente da ToolBox';
                        appendMessage('assistant', `Selecione uma categoria para que eu possa te ajudar com as ferramentas.`);
                        chatInput.disabled = true;
                        chatSendBtn.disabled = true;
                        return;
                    }
                    
                    let toolsForCurrentCategory;
                    if (activeCategory === 'all') {
                        toolsForCurrentCategory = activeTools;
                    } else {
                        toolsForCurrentCategory = activeTools.filter(t => t.category === activeCategory);
                    }
                    
                    const toolKnowledge = toolsForCurrentCategory.length > 0
                        ? toolsForCurrentCategory.map(t => {
                            const categoryInfo = activeCategory === 'all' ? ` (Categoria: ${t.category})` : '';
                            return `- Ferramenta: "${t.name}"${categoryInfo}\n  - Descrição: ${t.description}`;
                        }).join('\n\n')
                        : "Nenhuma ferramenta para esta categoria.";

                    const contextDescription = activeCategory === 'all' ? 'todas as suas categorias selecionadas' : `a categoria "${activeCategory}"`;
                    
                    systemInstruction = `Você é um assistente especialista da ToolBox Triad3, focado em ajudar o usuário, chamado ${userName}, a entender as ferramentas de ${contextDescription}.

**Sua Missão:**
Sua única função é tirar dúvidas sobre as ferramentas de ${contextDescription} listadas abaixo. Seja claro, prestativo e utilize quebras de linha para facilitar a leitura.

**Seu Conhecimento (Apenas estas ferramentas):**
---
${toolKnowledge}
---

**Diretrizes de Comportamento:**
1.  **Especialista Focado:** Responda apenas a perguntas relacionadas às ferramentas listadas.
2.  **Mencione os Tutoriais:** Sempre que for relevante e útil, informe ao usuário que a equipe da "Triad3 Inteligência Digital" criou vídeos tutoriais para um entendimento ainda mais profundo. Você pode dizer algo como: "Além disso, para te ajudar a dominar esta ferramenta, a equipe da Triad3 Inteligência Digital preparou um vídeo tutorial completo que você pode encontrar nesta mesma tela."
3.  **Não Desvie do Assunto:** Se ${userName} perguntar sobre qualquer outra coisa (outras categorias, como adicionar ferramentas, sobre você, etc.), gentilmente redirecione a conversa para o foco atual. Diga algo como: "Meu foco aqui é te ajudar com as ferramentas de ${contextDescription}. Você tem alguma dúvida sobre elas?".`;

                    const chatHeaderTitle = activeCategory === 'all' ? 'Assistente da ToolBox' : `Especialista em ${activeCategory}`;
                    chatHeader.querySelector('h3').textContent = chatHeaderTitle;
                    appendMessage('assistant', `Olá, ${userName}! Estou aqui para te ajudar com as ferramentas de ${contextDescription}. Sobre qual delas você tem alguma dúvida?`);
                }
                
                chat = ai.chats.create({ 
                    model: 'gemini-2.5-flash',
                    config: { systemInstruction }
                });
            }
            
            async function handleSendMessage() {
                if (isChatInProgress) return;
                
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;

                appendMessage('user', userMessage);
                chatInput.value = '';
                
                chatInput.disabled = true;
                chatSendBtn.disabled = true;
                isChatInProgress = true;

                const typingIndicator = appendMessage('assistant', '...', true);

                try {
                    const result = await chat.sendMessageStream({ message: userMessage });
                    let fullResponse = '';
                    typingIndicator.textContent = ''; 
                    for await (const chunk of result) {
                        const chunkText = chunk.text;
                        if(chunkText) {
                            fullResponse += chunkText;
                            typingIndicator.textContent = fullResponse;
                            chatBody.scrollTop = chatBody.scrollHeight;
                        }
                    }
                } catch (error) {
                    console.error("Gemini Error:", error);
                    typingIndicator.textContent = 'Desculpe, ocorreu um erro ao me comunicar. Tente novamente.';
                    typingIndicator.classList.add('error');
                } finally {
                    typingIndicator.classList.remove('typing');
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                    isChatInProgress = false;
                    chatInput.focus();
                }
            }
            
            // ======================= FUNÇÕES DE VISIBILIDADE DE TELA =======================
            function showScreen(screenId) {
                [userLoginSection, userRegisterSection, adminLoginSection, adminActionsSection, waitingListSection, adminPanelSection, editToolSection, editCategorySection, editCategoryFormSection, editToolFormSection, deleteToolSection, toolboxSection, iframeWrapper, onboardingSection, adminChangePasswordSection, addNewAdminSection, deleteConfirmModal, userDetailsModal, editCategoryConfirmModal, changePasswordConfirmModal, successRedirectModal, successToast]
                    .forEach(section => section.classList.add('hidden'));
                
                const screen = document.getElementById(screenId);
                if(screen) screen.classList.remove('hidden');

                if (screenId === 'onboarding-section' || screenId === 'toolbox-section') {
                    chatWidget.classList.remove('hidden');
                } else {
                    chatWidget.classList.add('hidden');
                    chatWindow.classList.add('hidden');
                }
            }

            // ======================= FUNÇÕES UTILITÁRIAS =======================
            
            async function fetchAllTools() {
                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/ferramentas2-toolbox-triad3', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    if (!Array.isArray(data)) throw new Error('Formato de dados inválido da API');

                    allTools = data.map(tool => ({
                        id: tool.id,
                        name: tool.nome || 'Nome Indisponível',
                        description: tool.descricao || 'Descrição indisponível.',
                        category: tool.categoria || 'Sem Categoria',
                        icon: tool.icon || '❓',
                        link: tool.link || '#',
                        video: tool.video || '',
                        dificuldade: tool.dificuldade || 'Iniciante',
                        tooltip: `Acessar a ferramenta ${tool.nome || ''}`,
                        status: tool.status === 'on' ? 'ativo' : 'inativo'
                    }));
                } catch (error) {
                    console.error('Falha ao buscar ferramentas:', error);
                    alert('Não foi possível carregar as ferramentas. Verifique a conexão e tente novamente.');
                }
            }

            function getVideoSource(url) {
                if (!url || typeof url !== 'string') return null;

                // YouTube
                try {
                    const ytUrl = new URL(url);
                    if (ytUrl.hostname === 'youtu.be') {
                        return { type: 'iframe', src: `https://www.youtube.com/embed/${ytUrl.pathname.slice(1)}` };
                    }
                    if (ytUrl.hostname.includes('youtube.com') && ytUrl.searchParams.has('v')) {
                        return { type: 'iframe', src: `https://www.youtube.com/embed/${ytUrl.searchParams.get('v')}` };
                    }
                } catch (e) { /* Ignora URLs inválidas */ }

                // Vimeo
                const vimeoRegex = /vimeo\.com\/(\d+)/;
                const vimeoMatch = url.match(vimeoRegex);
                if (vimeoMatch && vimeoMatch[1]) {
                    return { type: 'iframe', src: `https://player.vimeo.com/video/${vimeoMatch[1]}` };
                }

                // Arquivos de vídeo diretos (com suporte para query strings)
                if (url.match(/\.(mp4|webm|ogv)(\?.*)?$/i)) {
                    return { type: 'video', src: url };
                }
                
                return null; // Retorna nulo se não conseguir identificar
            }


            function applyTheme(themeName) {
                document.documentElement.setAttribute('data-theme', themeName);
                themeIcon.textContent = themeIcons[themeName] || '🌙';
                localStorage.setItem('theme', themeName);
            }

            function togglePasswordVisibility(input, button) {
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                button.querySelector('.icon-eye').classList.toggle('hidden', isPassword);
                button.querySelector('.icon-eye-off').classList.toggle('hidden', !isPassword);
                button.setAttribute('aria-label', isPassword ? 'Ocultar senha' : 'Mostrar senha');
            }

            // ======================= FUNÇÕES DE RENDERIZAÇÃO DA TOOLBOX =======================

            function renderTools(container, toolsToRender) {
                container.innerHTML = '';
                if (!toolsToRender || toolsToRender.length === 0) {
                    container.innerHTML = '<p style="color: var(--color-text-secondary); padding: 16px 0;">Nenhuma ferramenta encontrada.</p>';
                    return;
                }
                toolsToRender.forEach((tool, index) => {
                    const card = document.createElement('div');
                    card.className = 'tool-card';
                    card.style.animationDelay = `${index * 50}ms`;
                    card.setAttribute('title', tool.tooltip);
                    const difficultyClass = tool.dificuldade.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    card.innerHTML = `
                        <div class="tool-card-header">
                            <span class="tool-icon">${tool.icon}</span>
                            <h3>${tool.name}</h3>
                            <div class="difficulty-indicator ${difficultyClass}" title="Nível: ${tool.dificuldade}">
                                <span class="bar bar-1"></span>
                                <span class="bar bar-2"></span>
                                <span class="bar bar-3"></span>
                            </div>
                        </div>
                        <p>${tool.description}</p>
                        <div class="tool-card-footer">
                            <span class="tool-category-tag">${tool.category}</span>
                            <button type="button" class="tool-access-btn" data-link="${tool.link}" data-name="${tool.name}">Acessar</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            function renderCategoryContent(categoryName, searchTerm = '') {
                toolPanel.innerHTML = ''; 

                if (!categoryName) {
                    toolPanel.innerHTML = '<h2 class="section-title">Bem-vindo à sua ToolBox!</h2><p style="color: var(--color-text-secondary); padding: 16px 0;">Por favor, selecione uma categoria acima para visualizar as ferramentas disponíveis.</p>';
                    return;
                }

                let toolsForCategory;
                if (categoryName === 'all') {
                    toolsForCategory = activeTools;
                } else {
                    toolsForCategory = activeTools.filter(tool => tool.category === categoryName);
                }

                if (searchTerm.trim()) {
                    const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
                    const filteredToolsByName = toolsForCategory.filter(tool => 
                        tool.name.toLowerCase().includes(lowerCaseSearchTerm) || 
                        tool.description.toLowerCase().includes(lowerCaseSearchTerm)
                    );
                    
                    const filteredVideos = filteredToolsByName.filter(tool => tool.video && getVideoSource(tool.video));
                    renderTutorialSection(filteredVideos, searchTerm);
                    renderToolsSection(filteredToolsByName, searchTerm);

                } else {
                    const videosForCategory = toolsForCategory.filter(tool => tool.video && getVideoSource(tool.video));
                    renderTutorialSection(videosForCategory);
                    renderToolsSection(toolsForCategory);
                }
            }
            
            function renderTutorialSection(videos, searchTerm = '') {
                 const tutorialContainer = document.createElement('div');
                if (videos.length > 0) {
                    const firstVideoSource = getVideoSource(videos[0].video);
                    let playerHtml = '';
                    if (firstVideoSource) {
                        if (firstVideoSource.type === 'iframe') {
                             playerHtml = `<iframe id="tutorial-player" src="${firstVideoSource.src}" title="Video Player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
                        } else if (firstVideoSource.type === 'video') {
                             playerHtml = `<video id="tutorial-player" src="${source.src}" controls controlsList="nodownload" autoplay muted loop title="Video Player"></video>`;
                        }
                    }

                    tutorialContainer.innerHTML = `
                        <h2 class="section-title">VÍDEO TUTORIAL</h2>
                        <div id="tutorial-section">
                            <div id="video-player-wrapper">
                                ${playerHtml}
                            </div>
                            <div id="video-list">
                                ${videos.map((videoTool, index) => `
                                    <button class="video-list-item ${index === 0 ? 'active' : ''}" data-video-url="${videoTool.video}" data-video-id="${videoTool.id}">
                                        ${videoTool.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>`;
                } else {
                    tutorialContainer.innerHTML = `<h2 class="section-title">VÍDEO TUTORIAL</h2>`;
                    if (searchTerm) {
                        tutorialContainer.innerHTML += `<p style="color: var(--color-text-secondary); padding: 16px 0;">Nenhum tutorial encontrado para "${searchTerm}".</p>`;
                    } else {
                         tutorialContainer.innerHTML += `<p style="color: var(--color-text-secondary); padding: 16px 0;">Nenhum tutorial em vídeo para esta categoria.</p>`;
                    }
                }
                toolPanel.appendChild(tutorialContainer);
            }
            
            function renderToolsSection(tools, searchTerm = '') {
                const toolsContainer = document.createElement('div');
                toolsContainer.className = 'tool-grid-container';
                toolsContainer.innerHTML = `<h2 class="section-title">FERRAMENTAS</h2>`;
                const toolGrid = document.createElement('div');
                toolGrid.className = 'tool-grid';
                toolGrid.id = 'tool-grid';
                renderTools(toolGrid, tools);
                toolsContainer.appendChild(toolGrid);
                toolPanel.appendChild(toolsContainer);
            }

            function showToolbox(userName = 'Usuário') {
                showScreen('toolbox-section');
                userGreeting.textContent = `Olá, ${userName}!`;
                searchBar.value = '';

                categorySelector.innerHTML = '';
                if (selectedCategories.length > 0) {
                    const firstCategory = selectedCategories[0]; // Define a primeira categoria selecionada pelo usuário como padrão.

                    // Adiciona a opção "Todos" no início da lista.
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = 'Todos';
                    categorySelector.appendChild(allOption);
                    
                    // Adiciona as categorias que o usuário selecionou, e marca a primeira como pré-selecionada.
                    selectedCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        if (cat === firstCategory) {
                            option.selected = true;
                        }
                        categorySelector.appendChild(option);
                    });
                    
                    categorySelector.classList.remove('hidden');
                    
                    // Imediatamente carrega as ferramentas da categoria pré-selecionada.
                    renderCategoryContent(firstCategory);
                } else {
                    // Caso o usuário não tenha selecionado nenhuma categoria.
                    categorySelector.classList.add('hidden');
                    toolPanel.innerHTML = '<p>Nenhuma categoria foi selecionada. Por favor, volte e crie sua toolbox.</p>';
                }
            }


            // ======================= LÓGICA DE EVENTOS =======================

            document.getElementById('admin-page-btn').addEventListener('click', () => showScreen('admin-login-section'));
            document.getElementById('back-to-user-btn').addEventListener('click', () => showScreen('user-login-section'));

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginBtn = e.target.querySelector('.login-btn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verificando...';
                errorMessage.classList.remove('show');

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/login-toolbox-triade', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: emailInput.value.trim(), password: passwordInput.value.trim() })
                    });
                    const data = await response.json();

                    if (response.ok && data.resposta && data.resposta.includes('Sejá bem-vind@')) {
                        const userName = data.Nome || 'Usuário';
                        const userLevel = data.Nível || 'Avançado';
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('userName', userName);
                        localStorage.setItem('userLevel', userLevel);
                        
                        loadingOverlay.classList.remove('hidden');
                        await Promise.all([fetchAllTools(), new Promise(res => setTimeout(res, 2000))]);
                        loadingOverlay.classList.add('hidden');
                        
                        onboardingGreeting.textContent = `Olá, ${userName}!`;
                        onboardingCategoryGrid.innerHTML = '';
                        const categories = [...new Set(allTools.map(tool => tool.category))];
                        categories.forEach(category => {
                            const btn = document.createElement('button');
                            btn.className = 'onboarding-category-item';
                            btn.textContent = category;
                            btn.dataset.category = category;
                            onboardingCategoryGrid.appendChild(btn);
                        });
                        onboardingContinueBtn.disabled = true;
                        showScreen('onboarding-section');

                    } else {
                        throw new Error(data.resposta || 'Usuário ou senha incorretos.');
                    }
                } catch (error) {
                    errorMessage.textContent = error.message;
                    errorMessage.classList.add('show');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Entrar';
                }
            });
            
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const registerBtn = e.target.querySelector('.login-btn');
                registerBtn.disabled = true;
                registerBtn.textContent = 'Cadastrando...';
                registerErrorMessage.classList.remove('show');

                const name = document.getElementById('register-name').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const countryCode = document.getElementById('register-country-code').value;
                const phone = document.getElementById('register-phone').value.trim();
                const password = document.getElementById('register-password').value.trim();

                const payload = {
                    nome: name,
                    email: email,
                    telefone: `${countryCode}${phone}`,
                    senha: password
                };
                
                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/novousuario-toolbox', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();

                    if (!response.ok) {
                        // Check for the specific "email already registered" error.
                        if (data.resposta && data.resposta.includes("Este e-mail já está cadastrado")) {
                             registerErrorMessage.textContent = data.resposta;
                             registerErrorMessage.classList.add('show');
                             setTimeout(() => {
                                 registerErrorMessage.classList.remove('show');
                             }, 5000); // Show error for 5 seconds
                        } else {
                            // Throw a generic error for other server-side issues.
                            throw new Error(data.resposta || 'Ocorreu um erro ao tentar cadastrar.');
                        }
                    } else {
                        // Handle the success case.
                        const successMessageP = document.getElementById('success-redirect-message');
                        successMessageP.textContent = data.resposta;
                        showModal('success-redirect-modal');
                        registerForm.reset();
                        
                        setTimeout(() => {
                            hideModal('success-redirect-modal');
                            showScreen('user-login-section');
                        }, 5000); // Show success modal for 5 seconds
                    }

                } catch (error) {
                    // Catch network errors or the generic error thrown above.
                    registerErrorMessage.textContent = error.message;
                    registerErrorMessage.classList.add('show');
                    setTimeout(() => {
                        registerErrorMessage.classList.remove('show');
                    }, 5000);
                } finally {
                    // This block will run regardless of success or the specific error.
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'Cadastrar';
                }
            });

            onboardingCategoryGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('onboarding-category-item')) {
                    e.target.classList.toggle('selected');
                    const selectedCount = onboardingCategoryGrid.querySelectorAll('.selected').length;
                    onboardingContinueBtn.disabled = selectedCount === 0;
                }
            });

            onboardingContinueBtn.addEventListener('click', () => {
                const loadingText = loadingOverlay.querySelector('.loading-text');
                loadingText.textContent = 'Criando ToolBox...';
                loadingOverlay.classList.remove('hidden');

                setTimeout(() => {
                    const userName = localStorage.getItem('userName') || 'Usuário';
                    const selectedElements = onboardingCategoryGrid.querySelectorAll('.selected');
                    selectedCategories = Array.from(selectedElements).map(btn => btn.dataset.category);
                    
                    const userLevel = (localStorage.getItem('userLevel') || 'Avançado').toLowerCase();
                    const toolsFilteredByCategory = allTools.filter(tool => selectedCategories.includes(tool.category) && tool.status === 'ativo');
                    
                    if (userLevel === 'iniciante') {
                        activeTools = toolsFilteredByCategory.filter(tool => tool.dificuldade === 'Iniciante');
                    } else if (userLevel === 'intermediário') {
                        activeTools = toolsFilteredByCategory.filter(tool => 
                            tool.dificuldade === 'Iniciante' || tool.dificuldade === 'Intermediário'
                        );
                    } else { // 'avançado' or any other fallback
                        activeTools = toolsFilteredByCategory;
                    }
                    
                    showToolbox(userName);
                    
                    loadingOverlay.classList.add('hidden');
                    loadingText.textContent = 'Iniciando Sistema...';
                }, 2000);
            });

            backToOnboardingBtn.addEventListener('click', () => {
                const userName = localStorage.getItem('userName') || 'Usuário';
                onboardingGreeting.textContent = `Olá, ${userName}!`;
                showScreen('onboarding-section');
            });
            
            categorySelector.addEventListener('change', (e) => {
                searchBar.value = '';
                renderCategoryContent(e.target.value);
                // Re-initialize chat with new category context if window is open
                if (!chatWindow.classList.contains('hidden')) {
                    initChat();
                }
            });
            
            toolPanel.addEventListener('click', (e) => {
                const videoItem = e.target.closest('.video-list-item');
                if (videoItem) {
                    const playerWrapper = document.getElementById('video-player-wrapper');
                    const originalUrl = videoItem.dataset.videoUrl;
                    const source = getVideoSource(originalUrl);
                    
                    if (playerWrapper && source) {
                        let playerHtml = '';
                        if (source.type === 'iframe') {
                             playerHtml = `<iframe id="tutorial-player" src="${source.src}" title="Video Player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
                        } else if (source.type === 'video') {
                             playerHtml = `<video id="tutorial-player" src="${source.src}" controls controlsList="nodownload" autoplay muted loop title="Video Player"></video>`;
                        }
                        playerWrapper.innerHTML = playerHtml;
                        
                        document.querySelectorAll('.video-list-item.active').forEach(item => item.classList.remove('active'));
                        videoItem.classList.add('active');
                    }
                }
                
                const accessBtn = e.target.closest('.tool-access-btn');
                if (accessBtn) {
                    iframeToolName.textContent = accessBtn.dataset.name || 'Ferramenta';
                    toolIframe.src = accessBtn.dataset.link;
                    showScreen('iframe-wrapper');
                }
            });

            backToToolboxBtn.addEventListener('click', () => {
                toolIframe.src = 'about:blank';
                showScreen('toolbox-section');
            });

            searchBar.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                const activeCategory = categorySelector.value || (selectedCategories.length > 0 ? selectedCategories[0] : '');
                if (activeCategory) {
                    renderCategoryContent(activeCategory, searchTerm);
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                localStorage.clear();
                loginForm.reset();
                showScreen('user-login-section');
            });

            themeSwitcher.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'neon';
                const nextIndex = (themes.indexOf(currentTheme) + 1) % themes.length;
                applyTheme(themes[nextIndex]);
            });
            
            togglePasswordBtn.addEventListener('click', () => togglePasswordVisibility(passwordInput, togglePasswordBtn));
            registerTogglePasswordBtn.addEventListener('click', () => togglePasswordVisibility(registerPasswordInput, registerTogglePasswordBtn));
            adminTogglePasswordBtn.addEventListener('click', () => togglePasswordVisibility(adminPasswordInput, adminTogglePasswordBtn));
            
            goToRegisterBtn.addEventListener('click', () => {
                registerForm.reset();
                registerErrorMessage.classList.remove('show');
                showScreen('user-register-section');
            });
            backToLoginBtn.addEventListener('click', () => showScreen('user-login-section'));

            // Chat Widget Listeners
            chatToggleBtn.addEventListener('click', () => {
                chatWindow.classList.toggle('hidden');
                if (!chatWindow.classList.contains('hidden')) {
                    chatInput.focus();
                    initChat();
                }
            });

            chatCloseBtn.addEventListener('click', () => {
                chatWindow.classList.add('hidden');
            });
            
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            
            // ======================= LÓGICA DO PAINEL DE ADMIN =======================
            
            editToolStatusCheckbox.addEventListener('change', () => {
                editToolStatusText.textContent = editToolStatusCheckbox.checked ? 'Ativo' : 'Inativo';
                if (saveToolBtn) saveToolBtn.disabled = false;
            });
            
            async function checkNewUsers() {
                const notificationBell = document.querySelector('.notification-bell');
                newUsersList = [];
                if (notificationBell) notificationBell.classList.remove('has-notification');

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/verificarnovouser-toolbox', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) {
                        console.error('Falha ao verificar novos usuários:', response.statusText);
                        return;
                    }

                    const data = await response.json();

                    if (Array.isArray(data) && data.length > 0) {
                        newUsersList = data;
                        if (notificationBell) {
                            notificationBell.classList.add('has-notification');
                        }
                    }
                } catch (error) {
                    console.error('Erro durante a verificação de novos usuários:', error);
                }
            }

            function renderWaitingList() {
                waitingListContainer.innerHTML = '';
                if (newUsersList.length > 0) {
                    waitingListEmptyMessage.classList.add('hidden');
                    const userListWrapper = document.createElement('div');
                    userListWrapper.id = 'new-user-list';
                    newUsersList.forEach(user => {
                        const item = document.createElement('button');
                        item.className = 'tool-edit-item';
                        item.dataset.userId = user.id;
                        item.innerHTML = `
                            <span class="tool-icon">👤</span>
                            <div class="tool-edit-info">
                                <strong>${user.nome}</strong>
                                <span>Clique para aprovar</span>
                            </div>
                            <span class="edit-arrow">&rarr;</span>
                        `;
                        userListWrapper.appendChild(item);
                    });
                    waitingListContainer.appendChild(userListWrapper);
                } else {
                    waitingListEmptyMessage.classList.remove('hidden');
                }
            }
            
            function showAdminPanel() {
                showScreen('admin-panel-section');
                addToolForm.reset();
                updateProgressBar();
                resetCategorySelection();
                populateExistingCategories();
                selectedEmojiSpan.textContent = '❓';
                toolEmojiInput.value = '';
                addToolSuccessMessage.classList.remove('show');
            }
            
            function resetCategorySelection() {
                selectedCategoryText.textContent = 'Nenhuma categoria selecionada';
                selectedCategoryText.classList.remove('selected');
                categoryDisplay.classList.remove('active');
                toolCategoryValueInput.value = '';
                newCategoryGroup.classList.add('hidden');
                selectCategoryGroup.classList.add('hidden');
                newCategoryNameInput.value = '';
                if(existingCategorySelect.options.length > 0) existingCategorySelect.value = '';
                updateProgressBar();
            }

            function populateExistingCategories() {
                const categories = [...new Set(allTools.map(tool => tool.category).filter(c => c))];
                existingCategorySelect.innerHTML = '<option value="" disabled selected>Escolha...</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    existingCategorySelect.appendChild(option);
                });
                btnSelectCategory.disabled = categories.length === 0;
            }

            function populateEmojiPicker(pickerEl, selectedEl, inputEl, onSelectCallback) {
                pickerEl.innerHTML = '';
                emojiList.forEach(emoji => {
                    const span = document.createElement('span');
                    span.className = 'emoji-option';
                    span.textContent = emoji;
                    span.addEventListener('click', () => {
                        selectedEl.textContent = emoji;
                        inputEl.value = emoji;
                        pickerEl.classList.add('hidden');
                        if (onSelectCallback) onSelectCallback();
                    });
                    pickerEl.appendChild(span);
                });
            }

            function updateProgressBar() {
                const fields = [
                    toolNameInput,
                    toolLinkInput,
                    toolCategoryValueInput,
                    toolDifficultySelect,
                    toolEmojiInput,
                    toolDescriptionTextarea,
                ];
                const filledFields = fields.filter(input => input.value.trim() !== '').length;
                const progress = (filledFields / fields.length) * 100;
                formProgressBar.style.width = `${progress}%`;
                addToolBtn.disabled = progress < 100;
            }

            function renderEditList(container, items, renderItemFn) {
                container.innerHTML = '';
                if (items.length === 0) {
                    container.innerHTML = '<p>Nenhum item encontrado.</p>';
                    return;
                }
                const sortedItems = [...items].sort((a, b) => (a.name || a).localeCompare(b.name || b));
                sortedItems.forEach(item => {
                    container.appendChild(renderItemFn(item));
                });
            }

            function createToolListItem(tool, isDelete = false) {
                const item = document.createElement('button');
                item.className = 'tool-edit-item';
                item.dataset.toolId = tool.id;
                item.innerHTML = `
                    <span class="tool-icon">${tool.icon}</span>
                    <div class="tool-edit-info">
                        <div class="tool-name-wrapper">
                             <span class="status-indicator ${tool.status === 'ativo' ? 'active' : 'inactive'}" title="Status: ${tool.status === 'ativo' ? 'Ativo' : 'Inativo'}"></span>
                             <strong>${tool.name}</strong>
                        </div>
                        <span>${tool.category}</span>
                    </div>
                    <span class="edit-arrow">${isDelete ? '&times;' : '&rarr;'}</span>
                `;
                return item;
            }

            function createCategoryListItem(category) {
                 const item = document.createElement('button');
                item.className = 'tool-edit-item';
                item.dataset.categoryName = category;
                item.innerHTML = `
                    <div class="tool-edit-info">
                        <strong>${category}</strong>
                    </div>
                    <span class="edit-arrow">&rarr;</span>
                `;
                return item;
            }
            
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                }
            }

            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                }
            }

            adminLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginBtn = e.target.querySelector('.login-btn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Verificando...';
                adminErrorMessage.classList.remove('show');

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/loginadm-toolbox-triade', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: adminEmailInput.value.trim(), password: adminPasswordInput.value.trim() })
                    });
                    const data = await response.json();

                    if (response.ok && data.resposta && data.resposta.includes('Sejá bem-vind@')) {
                        localStorage.setItem('isAdminLoggedIn', 'true');
                        loadingOverlay.classList.remove('hidden');
                        await Promise.all([fetchAllTools(), checkNewUsers(), new Promise(res => setTimeout(res, 1000))]);
                        loadingOverlay.classList.add('hidden');
                        showScreen('admin-actions-section');
                    } else {
                        throw new Error(data.resposta || 'Email ou senha de ADM incorretos.');
                    }
                } catch (error) {
                    adminErrorMessage.textContent = error.message;
                    adminErrorMessage.classList.add('show');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Entrar como ADM';
                }
            });

            notificationBtn.addEventListener('click', () => {
                renderWaitingList();
                showScreen('waiting-list-section');
                const notificationBell = document.querySelector('.notification-bell');
                if (notificationBell) {
                    notificationBell.classList.remove('has-notification');
                }
            });

            backToAdminMenuFromWaitlistBtn.addEventListener('click', () => showScreen('admin-actions-section'));
            
            waitingListContainer.addEventListener('click', (e) => {
                const item = e.target.closest('.tool-edit-item');
                if (!item) return;

                const userId = parseInt(item.dataset.userId, 10);
                const user = newUsersList.find(u => u.id === userId);

                if (user) {
                    currentUserForApproval = { ...user };
                    
                    userDetailInitialView.classList.remove('hidden');
                    userDetailApprovalView.classList.add('hidden');
                    accessLevelSelection.classList.remove('hidden');
                    confirmAccessSelection.classList.add('hidden');
                    userApprovalMessage.classList.remove('show');
                    userApprovalMessage.textContent = '';
                    confirmAccessBtn.disabled = false;
                    confirmAccessBtn.textContent = 'Confirmar Acesso';
                    
                    userDetailName.textContent = user.nome;
                    userDetailEmail.textContent = user.email;
                    userDetailPhone.textContent = user.telefone;
                    showModal('user-details-modal');
                }
            });

            approveUserStartBtn.addEventListener('click', () => {
                userDetailInitialView.classList.add('hidden');
                userDetailApprovalView.classList.remove('hidden');
            });

            accessLevelSelection.addEventListener('click', (e) => {
                if (e.target.classList.contains('access-level-btn')) {
                    const level = e.target.dataset.level;
                    currentUserForApproval.accessLevel = level;
                    selectedAccessLevelSpan.textContent = level;
                    accessLevelSelection.classList.add('hidden');
                    confirmAccessSelection.classList.remove('hidden');
                }
            });

            backToLevelSelectionBtn.addEventListener('click', () => {
                confirmAccessSelection.classList.add('hidden');
                accessLevelSelection.classList.remove('hidden');
                delete currentUserForApproval.accessLevel;
            });

            confirmAccessBtn.addEventListener('click', async () => {
                if (!currentUserForApproval || !currentUserForApproval.accessLevel) return;

                confirmAccessBtn.disabled = true;
                confirmAccessBtn.textContent = 'Enviando...';
                userApprovalMessage.classList.remove('show');
                userApprovalMessage.style.color = '';

                const payload = {
                    id: currentUserForApproval.id,
                    nome: currentUserForApproval.nome,
                    email: currentUserForApproval.email,
                    telefone: currentUserForApproval.telefone,
                    categoria: currentUserForApproval.accessLevel
                };

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/aceitarnovouser-toolbox', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok || data.resposta !== 'Usuário cadastrado com sucesso') {
                        throw new Error(data.resposta || 'Não foi possível aprovar o usuário.');
                    }

                    userApprovalMessage.textContent = data.resposta;
                    userApprovalMessage.classList.add('show');
                    
                    newUsersList = newUsersList.filter(u => u.id !== currentUserForApproval.id);
                    
                    setTimeout(() => {
                        hideModal('user-details-modal');
                        currentUserForApproval = null;
                        renderWaitingList();
                    }, 2000);

                } catch (error) {
                    userApprovalMessage.textContent = `Erro: ${error.message}`;
                    userApprovalMessage.style.color = 'var(--color-triad-pink)';
                    userApprovalMessage.classList.add('show');
                    confirmAccessBtn.disabled = false;
                    confirmAccessBtn.textContent = 'Confirmar Acesso';
                }
            });

            closeUserDetailModalBtn.addEventListener('click', () => {
                hideModal('user-details-modal');
                currentUserForApproval = null;
            });

            goToAddToolBtn.addEventListener('click', showAdminPanel);

            goToEditToolBtn.addEventListener('click', () => {
                renderEditList(editToolList, allTools, tool => createToolListItem(tool));
                showScreen('edit-tool-section');
            });
            
            goToDeleteToolBtn.addEventListener('click', () => {
                renderEditList(deleteToolList, allTools, tool => createToolListItem(tool, true));
                showScreen('delete-tool-section');
            });

            goToEditCategoryBtn.addEventListener('click', () => {
                const categories = [...new Set(allTools.map(tool => tool.category).filter(Boolean))];
                renderEditList(editCategoryList, categories, category => createCategoryListItem(category));
                showScreen('edit-category-section');
            });
            
            goToChangePasswordBtn.addEventListener('click', () => {
                adminSettingsDropdown.classList.add('hidden');
                showScreen('admin-change-password-section');
                changePasswordForm.reset();
            });

            goToAddAdminBtnBtn.addEventListener('click', () => {
                adminSettingsDropdown.classList.add('hidden');
                addNewAdminForm.reset();
                addAdminErrorMessage.classList.remove('show');
                showScreen('add-new-admin-section');
            });

            backToEditToolSectionBtn.addEventListener('click', () => showScreen('edit-tool-section'));

            editToolList.addEventListener('click', (e) => {
                const item = e.target.closest('.tool-edit-item');
                if (!item) return;
                const toolToEdit = allTools.find(t => t.id == item.dataset.toolId);
                if (toolToEdit) {
                    editToolIdInput.value = toolToEdit.id;
                    editingToolNameSpan.textContent = toolToEdit.name;
                    editToolNameInput.value = toolToEdit.name;
                    editToolLinkInput.value = toolToEdit.link;
                    editToolVideoInput.value = toolToEdit.video || '';
                    editToolDifficultySelect.value = toolToEdit.dificuldade;
                    editToolDescriptionTextarea.value = toolToEdit.description;
                    editSelectedEmojiSpan.textContent = toolToEdit.icon || '❓';
                    editToolEmojiInput.value = toolToEdit.icon || '❓';
                    
                    editToolStatusCheckbox.checked = toolToEdit.status === 'ativo';
                    editToolStatusText.textContent = toolToEdit.status === 'ativo' ? 'Ativo' : 'Inativo';
                    
                    saveToolBtn.disabled = true;
                    editToolSuccessMessage.classList.remove('show');
                    showScreen('edit-tool-form-section');
                }
            });

            editCategoryList.addEventListener('click', (e) => {
                const item = e.target.closest('.tool-edit-item');
                if (!item) return;
                categoryToEdit = item.dataset.categoryName;
                if (categoryToEdit) {
                    editingCategoryNameSpan.textContent = categoryToEdit;
                    newCategoryNameInputForEdit.value = categoryToEdit;
                    saveCategoryBtn.disabled = true;
                    showScreen('edit-category-form-section');
                }
            });
            
            deleteToolList.addEventListener('click', (e) => {
                const item = e.target.closest('.tool-edit-item');
                if (!item) return;
                toolToDelete = allTools.find(t => t.id == item.dataset.toolId);
                if (toolToDelete) {
                    deleteConfirmText.innerHTML = `Você tem certeza que quer excluir a ferramenta "<strong>${toolToDelete.name}</strong>" permanentemente? <br> Esta ação não pode ser desfeita.`;
                    deleteToolSuccessMessage.classList.remove('show');
                    showModal('delete-confirm-modal');
                }
            });

            cancelDeleteBtn.addEventListener('click', () => {
                hideModal('delete-confirm-modal');
                toolToDelete = null;
            });
            
            confirmDeleteBtn.addEventListener('click', async () => {
                if (!toolToDelete) return;
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = 'Excluindo...';

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/excluirferramanta-toolboxtriad3', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(toolToDelete)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Ocorreu um erro ao excluir.' }));
                        throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                    }
                    allTools = allTools.filter(t => t.id !== toolToDelete.id);
                    deleteToolSuccessMessage.textContent = 'Ferramenta excluída com sucesso!';
                    deleteToolSuccessMessage.style.color = '';
                    deleteToolSuccessMessage.classList.add('show');
                    setTimeout(() => {
                        hideModal('delete-confirm-modal');
                        renderEditList(deleteToolList, allTools, tool => createToolListItem(tool, true));
                        toolToDelete = null;
                    }, 2000);
                } catch (error) {
                    console.error('Falha ao excluir ferramenta:', error);
                    deleteToolSuccessMessage.style.color = 'var(--color-triad-pink)';
                    deleteToolSuccessMessage.textContent = `Erro: ${error.message}`;
                    deleteToolSuccessMessage.classList.add('show');
                } finally {
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = 'Confirmar Exclusão';
                }
            });

            [backToAdminMenuBtn, backToAdminMenuFromEditBtn, backToAdminMenuFromDeleteBtn, backToAdminMenuFromPasswordBtn, backToAdminMenuFromAddAdminBtn].forEach(btn => {
                if (btn) btn.addEventListener('click', () => showScreen('admin-actions-section'));
            });
            backToEditListBtn.addEventListener('click', () => showScreen('edit-tool-section'));
            backToCategoryListBtn.addEventListener('click', () => showScreen('edit-category-section'));

            btnCreateCategory.addEventListener('click', () => {
                newCategoryGroup.classList.remove('hidden');
                selectCategoryGroup.classList.add('hidden');
                categoryDisplay.classList.add('active');
                selectedCategoryText.textContent = 'Criando nova categoria...';
                selectedCategoryText.classList.remove('selected');
                toolCategoryValueInput.value = '';
                newCategoryNameInput.focus();
                updateProgressBar();
            });

            btnSelectCategory.addEventListener('click', () => {
                selectCategoryGroup.classList.remove('hidden');
                newCategoryGroup.classList.add('hidden');
                categoryDisplay.classList.add('active');
                selectedCategoryText.textContent = 'Selecionando categoria...';
                selectedCategoryText.classList.remove('selected');
                toolCategoryValueInput.value = '';
                updateProgressBar();
            });

            newCategoryNameInput.addEventListener('input', (e) => {
                const categoryName = e.target.value.trim();
                toolCategoryValueInput.value = categoryName;
                if (categoryName) {
                    selectedCategoryText.textContent = `Nova: ${categoryName}`;
                    selectedCategoryText.classList.add('selected');
                } else {
                    selectedCategoryText.textContent = 'Criando nova categoria...';
                    selectedCategoryText.classList.remove('selected');
                }
                updateProgressBar();
            });

            existingCategorySelect.addEventListener('change', (e) => {
                const categoryName = e.target.value;
                toolCategoryValueInput.value = categoryName;
                if (categoryName) {
                    selectedCategoryText.textContent = `Selecionada: ${categoryName}`;
                    selectedCategoryText.classList.add('selected');
                }
                updateProgressBar();
            });
            
            emojiSelectBtn.addEventListener('click', () => emojiPicker.classList.toggle('hidden'));
            editEmojiSelectBtn.addEventListener('click', () => editEmojiPicker.classList.toggle('hidden'));
            
            adminSettingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                adminSettingsDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!emojiPicker.contains(e.target) && !emojiSelectBtn.contains(e.target)) {
                    emojiPicker.classList.add('hidden');
                }
                if (!editEmojiPicker.contains(e.target) && !editEmojiSelectBtn.contains(e.target)) {
                    editEmojiPicker.classList.add('hidden');
                }
                if (adminSettingsDropdown && !adminSettingsDropdown.classList.contains('hidden') && !adminSettingsMenu.contains(e.target)) {
                    adminSettingsDropdown.classList.add('hidden');
                }
            });
            
            addToolForm.addEventListener('input', updateProgressBar);
            addToolForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addToolBtn.disabled = true;
                addToolBtn.textContent = 'Adicionando...';
                addToolSuccessMessage.classList.remove('show');
                addToolSuccessMessage.style.color = '';

                const payload = {
                    nome: toolNameInput.value.trim(), link: toolLinkInput.value.trim(),
                    categoria: toolCategoryValueInput.value.trim(), dificuldade: toolDifficultySelect.value,
                    icon: toolEmojiInput.value.trim(), descricao: toolDescriptionTextarea.value.trim(),
                    video: toolVideoInput.value.trim(),
                    status_categoria: !newCategoryGroup.classList.contains('hidden') && newCategoryNameInput.value.trim() !== '' ? 'nova categoria' : undefined
                };
                
                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/novaferramenta2-toolbox', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Ocorreu um erro ao salvar.' }));
                        throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                    }
                    addToolSuccessMessage.textContent = 'Ferramenta adicionada com sucesso!';
                    addToolSuccessMessage.classList.add('show');
                    addToolForm.reset();
                    resetCategorySelection();
                    selectedEmojiSpan.textContent = '❓';
                    updateProgressBar();
                    setTimeout(() => addToolSuccessMessage.classList.remove('show'), 3000);
                    await fetchAllTools();
                    populateExistingCategories();
                } catch (error) {
                    console.error('Falha ao adicionar ferramenta:', error);
                    addToolSuccessMessage.style.color = 'var(--color-triad-pink)'; 
                    addToolSuccessMessage.textContent = `Erro: ${error.message}`;
                    addToolSuccessMessage.classList.add('show');
                } finally {
                    addToolBtn.textContent = 'Adicionar Ferramenta';
                    updateProgressBar();
                }
            });
            
            addNewAdminForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('add-new-admin-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Cadastrando...';
                addAdminErrorMessage.classList.remove('show');

                const payload = {
                    nome: document.getElementById('add-admin-name').value.trim(),
                    email: document.getElementById('add-admin-email').value.trim(),
                    senha: document.getElementById('add-admin-password').value.trim(),
                };

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/novoadm-toolbox', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.resposta || 'Não foi possível cadastrar o administrador.');
                    }

                    successToastMessage.textContent = 'Novo ADM adicionado com sucesso!';
                    showModal('success-toast');
                    addNewAdminForm.reset();

                    setTimeout(() => {
                        hideModal('success-toast');
                        showScreen('admin-actions-section');
                    }, 5000);

                } catch (error) {
                    addAdminErrorMessage.textContent = `Erro: ${error.message}`;
                    addAdminErrorMessage.classList.add('show');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Cadastrar Novo ADM';
                }
            });

            editToolForm.addEventListener('input', () => { saveToolBtn.disabled = false; });
            editToolForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (saveToolBtn.disabled) return;
                saveToolBtn.disabled = true;
                saveToolBtn.textContent = 'Salvando...';
                editToolSuccessMessage.classList.remove('show');

                const payload = {
                    id: editToolIdInput.value,
                    nome: editToolNameInput.value.trim(),
                    link: editToolLinkInput.value.trim(),
                    video: editToolVideoInput.value.trim(),
                    dificuldade: editToolDifficultySelect.value,
                    icon: editToolEmojiInput.value.trim(),
                    descricao: editToolDescriptionTextarea.value.trim(),
                    status: editToolStatusCheckbox.checked ? 'on' : 'off'
                };

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/editarferramenta-toolbox', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Ocorreu um erro ao atualizar.' }));
                        throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                    }
                    editToolSuccessMessage.textContent = 'Ferramenta atualizada com sucesso!';
                    editToolSuccessMessage.style.color = '';
                    editToolSuccessMessage.classList.add('show');
                    
                    // Manually update the status in the local 'allTools' array
                    const toolIndex = allTools.findIndex(t => t.id == payload.id);
                    if (toolIndex !== -1) {
                         const updatedTool = { ...allTools[toolIndex], ...payload };
                         // Re-translate status for internal consistency
                         updatedTool.status = payload.status === 'on' ? 'ativo' : 'inativo';
                         allTools[toolIndex] = updatedTool;
                    }

                    setTimeout(() => {
                        renderEditList(editToolList, allTools, tool => createToolListItem(tool));
                        showScreen('edit-tool-section');
                    }, 2000);
                } catch (error) {
                    console.error('Falha ao editar ferramenta:', error);
                    editToolSuccessMessage.style.color = 'var(--color-triad-pink)';
                    editToolSuccessMessage.textContent = `Erro: ${error.message}`;
                    editToolSuccessMessage.classList.add('show');
                    saveToolBtn.disabled = false;
                    saveToolBtn.textContent = 'Salvar Alterações';
                }
            });
            
            newCategoryNameInputForEdit.addEventListener('input', () => {
                const newName = newCategoryNameInputForEdit.value.trim();
                saveCategoryBtn.disabled = !newName || newName === categoryToEdit;
            });
            
            editCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = newCategoryNameInputForEdit.value.trim();
                if (saveCategoryBtn.disabled || !newName || newName === categoryToEdit) return;
                editCategoryConfirmText.innerHTML = `Você tem certeza que quer alterar a categoria "<strong>${categoryToEdit}</strong>" para "<strong>${newName}</strong>"?`;
                editCategorySuccessMessage.classList.remove('show');
                showModal('edit-category-confirm-modal');
            });

            cancelEditCategoryBtn.addEventListener('click', () => hideModal('edit-category-confirm-modal'));
            confirmEditCategoryBtn.addEventListener('click', async () => {
                const newName = newCategoryNameInputForEdit.value.trim();
                if (!categoryToEdit || !newName || newName === categoryToEdit) return;
                confirmEditCategoryBtn.disabled = true;
                confirmEditCategoryBtn.textContent = 'Alterando...';

                const payload = { categoria_antiga: categoryToEdit, categoria_nova: newName };

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/editarcategoria-toolboxtriad3', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Ocorreu um erro.' }));
                        throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                    }
                    allTools.forEach(tool => { if (tool.category === categoryToEdit) tool.category = newName; });
                    editCategorySuccessMessage.textContent = 'Categoria alterada com sucesso!';
                    editCategorySuccessMessage.style.color = '';
                    editCategorySuccessMessage.classList.add('show');
                    setTimeout(() => {
                        hideModal('edit-category-confirm-modal');
                        const categories = [...new Set(allTools.map(t => t.category).filter(Boolean))];
                        renderEditList(editCategoryList, categories, cat => createCategoryListItem(cat));
                        showScreen('edit-category-section');
                    }, 2000);
                } catch (error) {
                    console.error('Falha ao editar categoria:', error);
                    editCategorySuccessMessage.style.color = 'var(--color-triad-pink)';
                    editCategorySuccessMessage.textContent = `Erro: ${error.message}`;
                    editCategorySuccessMessage.classList.add('show');
                } finally {
                    confirmEditCategoryBtn.disabled = false;
                    confirmEditCategoryBtn.textContent = 'Confirmar';
                }
            });
            
            changePasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                showModal('change-password-confirm-modal');
            });

            cancelChangePasswordBtn.addEventListener('click', () => hideModal('change-password-confirm-modal'));
            confirmChangePasswordBtn.addEventListener('click', async () => {
                const email = document.getElementById('change-password-email').value.trim();
                const newPassword = document.getElementById('change-password-new').value.trim();
                if (!email || !newPassword) return;

                confirmChangePasswordBtn.disabled = true;
                confirmChangePasswordBtn.textContent = 'Alterando...';
                changePasswordSuccessMessage.classList.remove('show');
                changePasswordSuccessMessage.style.color = '';

                try {
                    const response = await fetch('https://webhook.triad3.io/webhook/atualizarsenha-adm', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, senha: newPassword })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.resposta || 'Ops! Algo não saiu como esperado.');
                    changePasswordSuccessMessage.textContent = data.resposta || 'Pronto! Sua nova senha já está ativa.';
                    changePasswordSuccessMessage.style.color = 'var(--color-dark-accent)';
                    changePasswordSuccessMessage.classList.add('show');
                    setTimeout(() => {
                        hideModal('change-password-confirm-modal');
                        showScreen('admin-actions-section');
                    }, 3000);
                } catch (error) {
                    changePasswordSuccessMessage.textContent = error.message;
                    changePasswordSuccessMessage.style.color = 'var(--color-triad-pink)';
                    changePasswordSuccessMessage.classList.add('show');
                } finally {
                     confirmChangePasswordBtn.disabled = false;
                     confirmChangePasswordBtn.textContent = 'Confirmar';
                }
            });

            adminLogoutBtn.addEventListener('click', () => {
                localStorage.removeItem('isAdminLoggedIn');
                document.querySelector('.notification-bell').classList.remove('has-notification');
                newUsersList = [];
                adminLoginForm.reset();
                showScreen('user-login-section');
            });

            // ======================= INICIALIZAÇÃO =======================
            function init() {
                const savedTheme = localStorage.getItem('theme');
                applyTheme(savedTheme && themes.includes(savedTheme) ? savedTheme : 'neon');
                
                populateEmojiPicker(emojiPicker, selectedEmojiSpan, toolEmojiInput, updateProgressBar);
                populateEmojiPicker(editEmojiPicker, editSelectedEmojiSpan, editToolEmojiInput, () => { saveToolBtn.disabled = false; });

                if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                     loadingOverlay.classList.remove('hidden');
                     Promise.all([fetchAllTools(), new Promise(res => setTimeout(res, 1000))]).then(() => {
                        loadingOverlay.classList.add('hidden');
                        showScreen('admin-actions-section');
                     });
                } else if (localStorage.getItem('isLoggedIn') === 'true') {
                    localStorage.clear();
                    showScreen('user-login-section');
                } else {
                    showScreen('user-login-section');
                }
            }

            init();
        });
    </script>
</body>
</html>